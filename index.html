
<!doctype html>
<html lang="my"> 
 <head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/dypos/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="dypos" href="/dypos/icons/icon-512x512.png">
  <link rel="manifest" href="/dypos/manifest.json">
  <link rel="manifest" href="/dypos/sw.js">
  <title>Modern POS System</title> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
 <style type="text/css" id="dcoder_stylesheet">
:root {
  --primary-color-light: #ff8839; /* Orange */
  --secondary-color-light: #ff9e5e; /* Light Orange */
  --accent-color-light: #eb843f; /* Orange */
  --success-color-light: #eb843f; /* Orange */
  --danger-color-light: #E63946; /* Red */
  --warning-color: #FFA500; /* Orange, consistent across modes */
  --info-color: #ff8839; /* Blue for Bluetooth */
  --text-color-light: #4e515e; /* Greyish sub-text */
  --text-emphasis-light: #26211c; /* Dark heading text */
  --bg-color-light: linear-gradient(135deg, #ffdeb2, #ffd0de, #eee8f0, #eee8f0, #ffdeb2); /* Peach to pink to light gray */
  --card-bg-light: linear-gradient(145deg, #eff1ff, #fff2f9); /* Light blue to pink */
  --glass-bg-light: rgba(247, 244, 255, 0.822); /* Semi-transparent light purple */
  --glass-border-light: rgba(228, 226, 240, 0.5); /* Semi-transparent light border */
  --border-color-light: #ccd1ee; /* Light blue-gray */
  --shadow-color-light: rgba(100, 100, 150, 0.329); /* Translucent greyish-blue */
  --hover-overlay-light: rgba(91, 105, 255, 0.05); /* Very light blue */
  --primary-color-dark: #ff8839; /* Orange */
  --secondary-color-dark: #ff9e5e; /* Light Orange */
  --accent-color-dark: #eb843f; /* Orange */
  --success-color-dark: #eb843f; /* Orange */
  --danger-color-dark: #FF4444; /* Red */
  --text-color-dark: #B0B0B0; /* Light Gray */
  --text-emphasis-dark: #FFFFFF; /* White */
  --bg-color-dark: linear-gradient(45deg, #1A0F2A, #131c30); /* Dark purple to dark gray */
  --card-bg-dark: linear-gradient(45deg, #3d236463, #24386465); /* Darker purple gradient */
  --glass-bg-dark: rgba(46, 44, 71, 0.7); /* Semi-transparent dark purple */
  --glass-border-dark: rgba(58, 43, 85, 0.5); /* Semi-transparent dark border */
  --border-color-dark: #3A2B55; /* Slightly lighter purple */
  --shadow-color-dark: rgba(0, 0, 0, 0.3); /* Darker shadow */
  --hover-overlay-dark: rgba(255, 140, 0, 0.1); /* Light orange */
  --border-radius: 12px;
  --transition-duration: 0.3s ease-in-out;
  --sidebar-width: 220px;
  --header-height: 56px;
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  margin: 0;
  padding: 0;
  background: var(--bg-color);
  color: var(--text-color-dark);
  transition: background-color var(--transition-duration), color var(--transition-duration);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  position: relative;
}

body.akmdark-mode {
  --primary-color: var(--primary-color-dark);
  --secondary-color: var(--secondary-color-dark);
  --accent-color: var(--accent-color-dark);
  --success-color: var(--success-color-dark);
  --danger-color: var(--danger-color-dark);
  --text-color: var(--text-color-dark);
  --text-emphasis: var(--text-emphasis-dark);
  --bg-color: var(--bg-color-dark);
  --card-bg: var(--card-bg-dark);
  --glass-bg: var(--glass-bg-dark);
  --glass-border: var(--glass-border-dark);
  --border-color: var(--border-color-dark);
  --shadow-color: var(--shadow-color-dark);
  --hover-overlay: var(--hover-overlay-dark);
}

body.akmlight-mode {
  --primary-color: var(--primary-color-light);
  --secondary-color: var(--secondary-color-light);
  --accent-color: var(--accent-color-light);
  --success-color: var(--success-color-light);
  --danger-color: var(--danger-color-light);
  --text-color: var(--text-color-light);
  --text-emphasis: var(--text-emphasis-light);
  --bg-color: var(--bg-color-light);
  --card-bg: var(--card-bg-light);
  --glass-bg: var(--glass-bg-light);
  --glass-border: var(--glass-border-light);
  --border-color: var(--border-color-light);
  --shadow-color: var(--shadow-color-light);
  --hover-overlay: var(--hover-overlay-light);
}

.akmapp-container {
  display: flex;
  min-height: calc(100vh - var(--header-height));
  padding-top: var(--header-height);
  visibility: hidden; /* Hide app until activated */
}

.akmapp-container.activated {
    visibility: visible;
}

.akmheader {
  height: var(--header-height);
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  box-shadow: 0 1px 2px var(--shadow-color);
  display: flex;
  align-items: center;
  padding: 0 15px;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
  transition: all var(--transition-duration);
  border-bottom: 1px solid var(--glass-border);
}

.akmlogo {
  font-size: 1.2rem;
  font-weight: bold;
  color: var(--primary-color);
  display: flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
}

.akmlogo i {
  font-size: 1.5rem;
}

.akmmenu-toggle {
  background: none;
  border: none;
  color: var(--text-emphasis);
  font-size: 1.3rem;
  cursor: pointer;
  margin-right: 15px;
  display: none;
}

.akmheader-actions {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 10px;
}

.akmtheme-toggle {
  background: none;
  border: none;
  color: var(--text-emphasis);
  cursor: pointer;
  font-size: 1.2rem;
}

.akmsidebar {
  width: var(--sidebar-width);
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  box-shadow: 2px 0 4px var(--shadow-color);
  position: fixed;
  top: var(--header-height);
  left: 0;
  bottom: 0;
  transition: transform var(--transition-duration), background-color var(--transition-duration);
  overflow-y: auto;
  z-index: 90;
  border-right: 1px solid var(--glass-border);
  transform: translateX(0);
}

.akmsidebar-collapsed {
  transform: translateX(-100%);
}

.akmsidebar.akmshow {
  transform: translateX(0);
}

.akmsidebar-menu {
  list-style: none;
  padding: 15px 0;
  margin: 0;
}

.akmmenu-title {
  padding: 8px 15px;
  font-size: 0.75rem;
  text-transform: uppercase;
  color: var(--text-color);
  opacity: 0.7;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.akmmenu-item {
  margin-bottom: 4px;
}

.akmmenu-link {
  display: flex;
  align-items: center;
  padding: 10px 15px;
  color: var(--text-emphasis);
  text-decoration: none;
  transition: background-color var(--transition-duration), color var(--transition-duration);
  border-radius: 6px;
  margin: 0 8px;
  font-weight: 500;
}

.akmmenu-link:hover {
  background-color: var(--hover-overlay);
}

.akmmenu-link.akmactive {
  background-color: var(--hover-overlay);
  color: var(--primary-color);
}

.akmmenu-link.akmactive i {
  color: var(--primary-color);
}

.akmmenu-link i {
  margin-right: 10px;
  font-size: 1rem;
  width: 20px;
  text-align: center;
  color: var(--secondary-color);
}

.akmmain-content {
  flex: 1;
  margin-left: var(--sidebar-width);
  padding: 20px;
  transition: margin-left var(--transition-duration);
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  min-height: calc(100vh - var(--header-height));
}

.akmmain-content-collapsed {
  margin-left: 0;
}

.akmcard {
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  border-radius: var(--border-radius);
  box-shadow: 0 1px 2px var(--shadow-color);
  padding: 15px;
  transition: background-color var(--transition-duration), box-shadow var(--transition-duration);
  border: 1px solid var(--glass-border);
  overflow: hidden;
  margin-top: 20px;
}

.akmcard-body {
  padding-top: 15px;
}

.akmcard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--glass-border);
  flex-wrap: wrap;
  gap: 10px;
}

.akmcard-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-emphasis);
  margin: 0;
}

.akmbtn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 8px 14px;
  border-radius: var(--border-radius);
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-duration);
  border: none;
  font-size: 0.85rem;
  white-space: nowrap;
  color: #ffffff;
  box-shadow: none;
}

.akmbtn:hover {
  filter: brightness(0.95);
}

.akmbtn i {
  margin-right: 6px;
}

.akmbtn-group {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.akmbtn-primary { background-color: var(--primary-color); }
.akmbtn-secondary { background-color: var(--secondary-color); }
.akmbtn-success { background-color: var(--success-color); }
.akmbtn-danger { background-color: var(--danger-color); }
.akmbtn-warning { background-color: var(--warning-color); color: white; }
.akmbtn-info { background-color: var(--info-color); color: white; }
.akmbtn-outline-primary {
  background-color: transparent;
  border: 1px solid var(--glass-border);
  color: var(--primary-color) !important;
  font-weight: 600;
}

.akmbtn-outline-primary:hover {
  background-color: var(--hover-overlay);
}

.akmbtn-sm {
  padding: 5px 10px;
  font-size: 0.75rem;
}

.akmbtn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  filter: grayscale(50%);
}

/* Dashboard Styles from Prototype 103 */
.akmstats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 15px;
}
.akmstat-card {
  display: flex;
  flex-direction: column;
  padding: 15px;
  border-radius: var(--border-radius);
   background: var(--glass-bg);
    backdrop-filter: blur(10px);
  box-shadow: 0 2px 4px var(--shadow-color);
  border: 1px solid var(--glass-border);
}
.akmstat-title {
  font-size: 0.85rem;
  color: var(--text-color);
  opacity: 0.8;
  margin-bottom: 8px;
}
.akmstat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-emphasis);
  margin-bottom: 8px;
  word-break: break-all;
}
.akmstat-change {
  font-size: 0.75rem;
  display: flex;
  align-items: center;
}
.akmstat-change i { margin-right: 4px; }
.akmstat-change.akmup { color: var(--success-color); }
.akmstat-change.akmdown { color: var(--danger-color); }
/* End of Dashboard Styles */


.akmtable-responsive {
  overflow-y: auto;
  max-height: 50vh; /* Default scroll height */
  -webkit-overflow-scrolling: touch;
}

.akmtable {
  width: 100%;
  border-collapse: collapse;
}

.akmtable th,
.akmtable td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid var(--glass-border);
  white-space: nowrap;
  color: var(--text-color);
  vertical-align: middle;
}

.akmtable td { color: var(--text-emphasis); }

.akmtable th {
  font-weight: 600;
  color: var(--text-emphasis);
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  position: sticky;
  top: 0;
  z-index: 10;
}

.akmtable tbody tr:hover { background-color: var(--hover-overlay); }

.akmtable td:last-child, .akmtable th:last-child {
  text-align: right;
}

.akmrow {
  display: flex;
  flex-wrap: wrap;
  margin-right: -15px;
  margin-left: -15px;
}

.akmcol-md-8, .akmcol-md-6, .akmcol-md-4, .akmcol-sm-12 {
  position: relative;
  width: 100%;
  padding-right: 15px;
  padding-left: 15px;
  box-sizing: border-box;
}

@media (min-width: 768px) {
  .akmcol-md-4 { flex: 0 0 33.333333%; max-width: 33.333333%; }
  .akmcol-md-6 { flex: 0 0 50%; max-width: 50%; }
  .akmcol-md-8 { flex: 0 0 66.666667%; max-width: 66.666667%; }
}

.akmorder-details {
  display: flex;
  flex-direction: column;
  height: 100%;
  min-height: 400px;
}

.akmorder-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--glass-border);
  flex-wrap: wrap;
  gap: 8px;
}

.akmorder-header h3 { margin: 0; color: var(--text-emphasis); }

.akmorder-items {
  flex: 1;
  overflow-y: auto;
  margin-bottom: 15px;
  min-height: 150px;
}

.akmorder-summary {
  border-top: 2px solid var(--glass-border);
  padding-top: 12px;
}

.akmsummary-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 0.9rem;
  color: var(--text-color);
}

.akmsummary-label { font-weight: 600; }
.akmsummary-value { font-weight: 700; color: var(--text-emphasis); }

.akmdiscount-input {
  width: 100px;
  padding: 4px 8px;
  text-align: right;
  border: 1px solid var(--glass-border);
  background: var(--glass-bg);
  color: var(--text-emphasis);
  border-radius: 6px;
  font-size: 0.9rem;
}

.akmdiscount-input:focus {
  outline: none;
  border-color: var(--primary-color);
}

.akmgrand-total {
  font-size: 1.1rem;
  color: var(--primary-color);
}

.akmgrand-total .akmsummary-label, .akmgrand-total .akmsummary-value {
  font-weight: 700;
  color: var(--primary-color);
}

.akmpayment-options {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
    border-top: 1px solid var(--glass-border);
    padding-top: 10px;
}

.akmpayment-btn {
    flex: 1;
    padding: 8px;
    font-size: 0.8rem;
    background-color: transparent;
    border: 1px solid var(--glass-border);
    color: var(--text-emphasis);
}

.akmpayment-btn.akmactive {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.akmcategory-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
  overflow-x: auto;
  padding-bottom: 8px;
  white-space: nowrap;
}

.akmcategory-tabs::-webkit-scrollbar { display: none; }
.akmcategory-tabs { -ms-overflow-style: none; scrollbar-width: none; }

.akmcategory-tab {
  padding: 6px 12px;
  border-radius: 16px;
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  color: var(--text-emphasis);
  font-size: 0.85rem;
  cursor: pointer;
  transition: all var(--transition-duration);
  border: 1px solid var(--glass-border);
  font-weight: 500;
}

.akmcategory-tab:hover {
  background-color: var(--hover-overlay);
}

.akmcategory-tab.akmactive {
  background-color: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

.akmproducts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 15px;
}

.akmproduct-card {
  display: flex;
  flex-direction: column;
  border-radius: var(--border-radius);
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  box-shadow: 0 1px 2px var(--shadow-color);
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  border: 1px solid var(--glass-border);
  position: relative;
}

.akmproduct-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px var(--shadow-color);
}

.akmproduct-image {
  height: 120px;
  background-color: var(--glass-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-emphasis);
  opacity: 0.8;
}

.akmproduct-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.akmproduct-image i { font-size: 2.5rem; }

.akmproduct-details { padding: 10px; text-align: center; }

.akmproduct-name {
  font-weight: 600;
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 0.9rem;
  color: var(--text-emphasis);
}

.akmproduct-price {
  color: var(--primary-color);
  font-weight: 700;
  font-size: 0.85rem;
}

.akmform-group { margin-bottom: 12px; }

.akmform-label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: var(--text-emphasis);
  font-size: 0.9rem;
}

.akmform-control {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--glass-border);
  border-radius: var(--border-radius);
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  color: var(--text-emphasis);
  transition: border-color var(--transition-duration), box-shadow var(--transition-duration);
  box-sizing: border-box;
  font-size: 0.9rem;
}

body.akmlight-mode .akmform-control {
  background: var(--glass-bg-light);
}

select.akmform-control {
  appearance: none;
  background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FF8C00%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 10px 10px;
  padding-right: 30px;
}

body.akmlight-mode select.akmform-control {
  background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%235b69ff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
}

.akmform-control:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(255, 140, 0, 0.2);
}

body.akmlight-mode .akmform-control:focus {
  box-shadow: 0 0 0 2px rgba(91, 105, 255, 0.2);
}

input[type="date"]::-webkit-calendar-picker-indicator, 
input[type="datetime-local"]::-webkit-calendar-picker-indicator { 
  filter: invert(40%) sepia(88%) saturate(2559%) hue-rotate(20deg) brightness(100%) contrast(104%); 
}

body.akmdark-mode input[type="date"]::-webkit-calendar-picker-indicator, 
body.akmdark-mode input[type="datetime-local"]::-webkit-calendar-picker-indicator { 
  filter: invert(1); 
}

.akmmodal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(0, 0, 0, 0.6);
  z-index: 1000;
  overflow-y: auto;
  padding: 15px;
}

.akmmodal.akmshow {
  display: flex;
  align-items: center;
  justify-content: center;
}

.akmmodal-dialog {
  width: 100%;
  max-width: 450px;
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  border-radius: var(--border-radius);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  margin: auto;
  border: 1px solid var(--glass-border);
  display: flex;
  flex-direction: column;
  max-height: calc(100vh - 30px);
}

.akmmodal-header {
  padding: 12px 15px;
  border-bottom: 1px solid var(--glass-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.akmmodal-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-emphasis);
  margin: 0;
}

.akmmodal-close {
  background: none; 
  border: none;
  font-size: 1.5rem; 
  color: var(--text-color);
  opacity: 0.8; 
  cursor: pointer; 
  padding: 4px; 
  line-height: 1;
}

.akmmodal-close:hover { 
  color: var(--text-emphasis); 
}

.akmmodal-body {
  padding: 15px;
  overflow-y: auto;
  color: var(--text-emphasis);
}

.akmmodal-footer {
  padding: 12px 15px;
  border-top: 1px solid var(--glass-border);
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  flex-wrap: wrap;
}

#report-modal .akmmodal-dialog,
#sale-details-modal .akmmodal-dialog { 
  max-width: 800px; 
}

#sale-details-modal {
    z-index: 1010;
}

.akmempty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 30px 15px;
  text-align: center;
  color: var(--text-emphasis);
  opacity: 0.6;
  min-height: 150px;
}

.akmempty-state i {
  font-size: 2.5rem;
  margin-bottom: 12px;
  color: var(--secondary-color);
}

.akmempty-state p {
  font-size: 1rem;
  margin-bottom: 15px;
  color: var(--text-color);
}

.akmfooter {
  color: var(--text-color);
  text-align: center;
  padding: 15px;
  font-size: 0.8rem;
  margin-top: auto;
}

.akmbottom-nav {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 55px;
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  border-top: 1px solid var(--glass-border);
  justify-content: space-around;
  align-items: center;
  z-index: 1000;
  box-shadow: 0 -2px 5px var(--shadow-color);
}

.akmbottom-nav-link {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex-grow: 1;
  color: var(--secondary-color);
  text-decoration: none;
  font-size: 0.7rem;
  padding: 5px 0;
  transition: color 0.3s;
}

.akmbottom-nav-link i {
  font-size: 1.4rem;
  margin-bottom: 4px;
}

.akmbottom-nav-link.akmactive {
  color: var(--primary-color);
}

@media (max-width: 991.98px) {
  .akmsidebar { transform: translateX(-100%); z-index: 110; }
  .akmsidebar.akmshow { transform: translateX(0); }
  .akmmain-content { margin-left: 0; }
  .akmmain-content-collapsed { margin-left: 0; }
  .akmmenu-toggle { display: block; }
  body.akmsidebar-open::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0, 0, 0, 0.4);
    z-index: 105;
  }
}

@media (max-width: 767.98px) {
  .akmstats-grid { grid-template-columns: 1fr; }
  .akmorder-details { margin-top: 15px; min-height: auto; }
  .akmproducts-grid {
    display: grid;
    grid-auto-flow: column;
    grid-template-rows: repeat(3, auto);
    grid-auto-columns: 120px;
    overflow-x: auto;
    gap: 12px;
    padding-bottom: 10px;
    -webkit-overflow-scrolling: touch;
    grid-template-columns: unset;
    flex-wrap: unset;
  }
  .akmproducts-grid::-webkit-scrollbar {
    display: none;
  }
  .akmproducts-grid {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .akmproducts-grid .akmproduct-card {
    width: auto; 
  }
  .akmcard { padding: 12px; }
  .akmcard-title { font-size: 1rem; }
  .akmbtn { padding: 6px 12px; font-size: 0.8rem; }
  .akmproduct-image { height: 100px; }
  .akmproduct-image i { font-size: 1.5rem; }
  .akmtable th, .akmtable td { padding: 8px 10px; }
  .akmrow .akmcol-md-6 { margin-bottom: 15px; }
  .akmrow .akmcol-md-6:last-child { margin-bottom: 0; }
  .akmfooter {
    display: none;
  }
  .akmbottom-nav {
    display: flex;
  }
  .akmmain-content {
    padding-bottom: 70px;
  }
  .akmsidebar .akmhide-on-mobile {
    display: none;
  }
}

@media (max-width: 575.98px) {
  .akmheader { padding: 0 10px; }
  .akmlogo { font-size: 1rem; }
  .akmlogo i { font-size: 1.2rem; }
  .akmheader-actions { gap: 8px; }
  .akmmodal-dialog { max-width: calc(100% - 30px); margin: 15px auto; }
  #report-modal .akmmodal-dialog,
  #sale-details-modal .akmmodal-dialog { max-width: calc(100% - 30px); }
  .akmtable th, .akmtable td { padding: 6px 8px; font-size: 0.8rem; }
  .akmtable .akmbtn { padding: 4px 6px; font-size: 0.7rem; }
  .akmproducts-grid {
    grid-auto-columns: 110px;
  }
  .akmproduct-image { height: 80px; }
  .akmproduct-details { padding: 8px; }
  .akmproduct-name, .akmproduct-price { font-size: 0.8rem; }
  .akmstat-value { font-size: 1.3rem; }
}

.akmfilter-controls {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
  flex-wrap: wrap;
  align-items: flex-end;
}

.akmsearch-box {
  position: relative;
  flex-grow: 1;
  display: flex;
  align-items: center;
}

.akmsearch-box input {
  width: 100%;
  padding: 10px 15px 10px 35px;
  border-radius: var(--border-radius);
  border: 1px solid var(--glass-border);
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  color: var(--text-emphasis);
  box-sizing: border-box;
}

.akmsearch-box i {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-color);
}

#product-category-filter, #stock-category-filter {
  flex-basis: 200px;
  flex-grow: 0;
}

.akmfilter-group {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.akmfilter-group label {
  margin: 0 5px 0 0;
  font-size: 0.85rem;
  white-space: nowrap;
}

.akmimage-upload-container {
  margin-top: 10px;
  position: relative;
}

#product-image-preview {
  width: 100%;
  height: 150px;
  border-radius: var(--border-radius);
  object-fit: cover;
  border: 2px dashed var(--glass-border);
  cursor: pointer;
}

#remove-image-btn {
  position: absolute;
  top: 5px;
  right: 5px;
}

.akmproduct-table-image {
  width: 50px;
  height: 50px;
  object-fit: cover;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.2s;
}

.akmproduct-table-image:hover {
  transform: scale(1.1);
}

#image-viewer-modal .akmmodal-dialog {
  max-width: 80vw;
  background: transparent;
  border: none;
  box-shadow: none;
}

#full-size-image {
  max-width: 100%;
  max-height: 80vh;
  border-radius: var(--border-radius);
}

.akmproduct-card.akmdisabled {
  opacity: 0.6;
  cursor: not-allowed;
  pointer-events: none;
}

.akmproduct-card.akmdisabled .akmproduct-image {
  background-color: rgba(255, 68, 68, 0.1);
}

.akmproduct-card.akmdisabled .akmproduct-price {
  color: var(--danger-color);
}

.akmout-of-stock {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: rgba(255, 68, 68, 0.8);
  color: white;
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: bold;
}

#receipt-modal .akmmodal-dialog {
  max-width: 400px;
}

#receipt-content {
  padding: 20px;
  font-family: 'Courier New', Courier, monospace;
  color: var(--text-emphasis);
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
}

#receipt-content h4 {
  text-align: center;
  margin-top: 0;
  color: var(--primary-color);
}

#receipt-content p {
  font-size: 0.8rem;
  margin: 2px 0;
}

#receipt-content .akmreceipt-divider {
  border-top: 1px dashed var(--text-color);
  margin: 10px 0;
}

#receipt-content table {
  width: 100%;
  font-size: 0.8rem;
}

#receipt-content th, #receipt-content td {
  padding: 2px;
}

#receipt-content .akmtext-right {
  text-align: right;
}

#receipt-content .akmtotal-section {
  margin-top: 10px;
  font-weight: bold;
}

#receipt-content .akmfooter-text {
  text-align: center;
  margin-top: 15px;
  font-size: 0.7rem;
}

#reset-confirm-input {
  margin-top: 10px;
}

#barcode-scanner-container {
  width: 100%;
  border: 1px solid var(--glass-border);
}

#launch-scanner-btn {
  margin-left: 10px;
  flex-shrink: 0;
}

.akm-input-error {
    border-color: var(--danger-color) !important;
    animation: shake 0.5s;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

#activation-modal .akmmodal-dialog {
    max-width: 380px;
}
.akmstock-status {
  font-size: 0.75rem;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 16px;
  text-align: center;
}

.akmstock-status.akmlow {
  background-color: rgba(255, 68, 68, 0.2);
  color: var(--danger-color);
  border: 1px solid rgba(255, 68, 68, 0.3);
}

.akmstock-status.akmnormal {
  background-color: rgba(255, 140, 0, 0.2);
  color: var(--success-color);
  border: 1px solid rgba(255, 140, 0, 0.3);
}

.akmstock-status.akmexpiring {
  background-color: rgba(255, 165, 0, 0.2);
  color: var(--warning-color);
  border: 1px solid rgba(255, 165, 0, 0.3);
}

.akm-input-with-btn {
    display: flex;
    align-items: center;
}
.akm-input-with-btn .akmform-control {
    flex-grow: 1;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}
.akm-input-with-btn .akmbtn {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    flex-shrink: 0;
}

</style>
</head> 
 <body> 
  <!-- ============== ACTIVATION MODAL ============== -->
  <div class="akmmodal" id="activation-modal">
    <div class="akmmodal-dialog">
        <div class="akmmodal-content">
            <div class="akmmodal-header">
                <h3 class="akmmodal-title">Activation Required</h3>
            </div>
            <div class="akmmodal-body">
                <p>Please enter the activation code to use the application.</p>
                <div class="akmform-group">
                    <label for="activation-code-input" class="akmform-label">Activation Code</label>
                    <input type="text" id="activation-code-input" class="akmform-control" autocomplete="off" autofocus>
                    <p id="activation-error" style="color: var(--danger-color); font-size: 0.8rem; margin-top: 5px; display: none;">Invalid code. Please try again.</p>
                </div>
            </div>
            <div class="akmmodal-footer">
                <button type="button" class="akmbtn akmbtn-primary" id="submit-activation-btn">Activate</button>
            </div>
        </div>
    </div>
  </div>

  <div class="akmapp-container"> 
   <header class="akmheader"> <button class="akmmenu-toggle"><i class="fas fa-bars"></i></button> 
    <div class="akmlogo">
     <span>P O S</span> 
    </div> 
    <div class="akmheader-actions"> <button class="akmtheme-toggle"><i class="fas fa-moon"></i></button> 
    </div> 
   </header> 
   <aside class="akmsidebar"> 
    <ul class="akmsidebar-menu"> 
     <li class="akmmenu-title" data-translate="menu_main">Main</li> 
     <li class="akmmenu-item akmhide-on-mobile"><a href="#" class="akmmenu-link akmactive" data-section="dashboard"><i class="fas fa-tachometer-alt"></i><span data-translate="menu_dashboard">Dashboard</span></a></li> 
     <li class="akmmenu-item akmhide-on-mobile"><a href="#" class="akmmenu-link" data-section="orders"><i class="fas fa-cash-register"></i><span data-translate="menu_new_sale">New Sale</span></a></li> 
     <li class="akmmenu-title" data-translate="menu_management">Management</li> 
     <li class="akmmenu-item"><a href="#" class="akmmenu-link" data-section="products"><i class="fas fa-box-open"></i><span data-translate="menu_products">Products</span></a></li> 
     <li class="akmmenu-item"><a href="#" class="akmmenu-link" data-section="categories"><i class="fas fa-tags"></i><span data-translate="menu_categories">Categories</span></a></li> 
     <li class="akmmenu-item akmhide-on-mobile"><a href="#" class="akmmenu-link" data-section="stock"><i class="fas fa-warehouse"></i><span data-translate="menu_stock">Stock</span></a></li> 
     <li class="akmmenu-item" id="expiring-soon-menu-item" style="display: none;"><a href="#" class="akmmenu-link" data-section="expiring-soon"><i class="fas fa-hourglass-half"></i><span data-translate="menu_expiring_soon">Expiring Soon</span></a></li> 
     <li class="akmmenu-item"><a href="#" class="akmmenu-link" data-section="purchases"><i class="fas fa-truck-loading"></i><span data-translate="menu_purchases">Purchases</span></a></li> 
     <li class="akmmenu-title" data-translate="menu_reports">Reports</li> 
     <li class="akmmenu-item"><a href="#" class="akmmenu-link" data-section="reports"><i class="fas fa-chart-bar"></i><span data-translate="menu_reports_link">Reports</span></a></li> 
      
     <li class="akmmenu-title">Setting</li>
     <li class="akmmenu-item"><a href="#" class="akmmenu-link" data-section="settings"><i class="fas fa-cog"></i><span data-translate="menu_settings">Settings</span></a></li> 
     <li class="akmmenu-item"><a href="#" class="akmmenu-link" data-section="about"><i class="fas fa-info-circle"></i><span data-translate="menu_about">About</span></a></li>
    </ul> 
   </aside> 
   <main class="akmmain-content"> 
    <section id="dashboard-section" class="akmcontent-section"> 
     <div class="akmcard"> 
      <div class="akmcard-header"> 
       <h2 class="akmcard-title" data-translate="dashboard_title">Today's Overview</h2> 
       <div class="akmbtn-group"> <button class="akmbtn akmbtn-primary" type="button" id="new-order-btn"><i class="fas fa-plus"></i> <span data-translate="btn_new_sale">New Sale</span></button> 
       </div> 
      </div> 
      <div class="akmstats-grid"> 
       <div class="akmstat-card"> <span class="akmstat-title" data-translate="stat_sales_today">Sales Today</span> <span class="akmstat-value" id="total-orders">0</span> <span class="akmstat-change akmup"><i class="fas fa-arrow-up"></i><span>-</span></span> 
       </div> 
       <div class="akmstat-card"> <span class="akmstat-title" data-translate="stat_todays_profit">Today's Profit</span> <span class="akmstat-value" id="net-profit">0 ကျပ်</span> <span class="akmstat-change akmdown"><i class="fas fa-arrow-down"></i><span>-</span></span> 
       </div> 
       <div class="akmstat-card"> <span class="akmstat-title" data-translate="stat_sales_revenue">Sales Revenue</span> <span class="akmstat-value" id="sales-revenue">0</span> <span class="akmstat-change akmup"><i class="fas fa-arrow-up"></i><span>-</span></span> 
       </div> 
       <div class="akmstat-card"> <span class="akmstat-title" data-translate="stat_low_stock">Low Stock Items</span> <span class="akmstat-value" id="low-stock-items">0</span> <span class="akmstat-change akmdown"><i class="fas fa-arrow-down"></i><span>-</span></span> 
       </div> 
      </div> 
     </div> 
    </section> 
    <section id="orders-section" class="akmcontent-section" style="display: none;"> 
     <div class="akmrow"> 
      <div class="akmcol-md-8 akmcol-sm-12"> 
       <div class="akmcard"> 
        <div class="akmcard-header"> 
         <h3 class="akmcard-title" style="font-size: 1rem;" data-translate="orders_add_items">Add Items</h3> 
         <div class="akmsearch-box"> <i class="fas fa-search"></i> 
          <input type="text" id="product-search" data-translate-placeholder="placeholder_search_products"> 
          <button class="akmbtn akmbtn-secondary" id="launch-scanner-btn" style="display:none;"><i class="fas fa-barcode"></i></button>
         </div> 
        </div> 
        <div class="akmcategory-tabs" id="category-tabs"> 
        </div> 
        <div id="products-grid" class="akmproducts-grid"> 
         <div class="akmempty-state"> <i class="fas fa-chair"></i> 
          <p data-translate="empty_select_table">Select an item to begin</p> 
         </div> 
        </div> 
       </div> 
      </div> 
      <div class="akmcol-md-4 akmcol-sm-12"> 
       <div class="akmcard akmorder-details"> 
        <div class="akmorder-header"> 
         <h3><span data-translate="label_sale">Sale</span> #<span id="current-order-id">-</span></h3> 
         <div class="akmbtn-group"> <button class="akmbtn akmbtn-success" type="button" id="complete-order-btn" disabled><i class="fas fa-check"></i> <span data-translate="btn_complete">Complete</span></button> <button type="button" class="akmbtn akmbtn-danger" id="cancel-order-btn" disabled><i class="fas fa-times"></i> <span data-translate="btn_cancel">Cancel</span></button> 
         </div> 
        </div> 
        <div class="akmorder-items"> 
         <table class="akmtable"> 
          <thead> 
           <tr> 
            <th data-translate="table_item">Item</th> 
            <th data-translate="table_qty">Qty</th> 
            <th data-translate="table_price">Price</th> 
            <th data-translate="table_total">Total</th> 
           </tr> 
          </thead> 
          <tbody id="order-items-list"> 
           <tr> 
            <td colspan="4"> 
             <div class="akmempty-state" style="min-height: 50px; padding: 10px;"> 
              <p style="font-size: 0.8rem; margin: 0;" data-translate="empty_no_items_added">No items added</p> 
             </div> </td> 
           </tr> 
          </tbody> 
         </table> 
        </div> 
        <div class="akmorder-summary"> 
         <div class="akmsummary-row"> <span class="akmsummary-label" data-translate="label_subtotal">Subtotal:</span> <span class="akmsummary-value" id="order-subtotal">0 ကျပ်</span> 
         </div> 
         <div class="akmsummary-row"> 
            <span class="akmsummary-label" data-translate="label_discount">Discount:</span> 
            <input type="number" id="order-discount" class="akmdiscount-input" placeholder="0" min="0">
         </div>
         <div class="akmsummary-row"> <span class="akmsummary-label" id="order-tax-label">Tax (0%):</span> <span class="akmsummary-value" id="order-tax">0 ကျပ်</span> 
         </div> 
         <div id="payment-method-group">
            <div class="akmpayment-options">
                <button class="akmbtn akmpayment-btn akmactive" data-payment="cash"><i class="fas fa-money-bill-wave"></i> <span data-translate="payment_cash">Cash</span></button>
                <button class="akmbtn akmpayment-btn" data-payment="card"><i class="fas fa-credit-card"></i> <span data-translate="payment_card">Card</span></button>
                <button class="akmbtn akmpayment-btn" data-payment="kbzpay"><i class="fas fa-mobile-alt"></i> <span data-translate="payment_kbzpay">KBZ Pay</span></button>
            </div>
         </div>
         <div class="akmsummary-row akmgrand-total"> <span class="akmsummary-label" data-translate="label_grand_total">Grand Total:</span> <span class="akmsummary-value" id="order-total">0 ကျပ်</span> 
         </div> 
        </div> 
       </div> 
      </div> 
     </div> 
    </section> 
    <section id="products-section" class="akmcontent-section" style="display: none;"> 
     <div class="akmcard"> 
      <div class="akmcard-header"> 
       <h2 class="akmcard-title" data-translate="menu_products">Products</h2> 
       <div class="akmbtn-group"> <button class="akmbtn akmbtn-primary" type="button" id="add-new-product-btn"><i class="fas fa-plus"></i> <span data-translate="btn_add_product">Add Product</span></button> 
       </div> 
      </div> 
      <div class="akmfilter-controls"> 
       <div class="akmsearch-box"> <i class="fas fa-search"></i> 
        <input type="text" id="products-search-input" data-translate-placeholder="placeholder_search_products"> 
       </div> <select id="product-category-filter" class="akmform-control"> <option value="all" data-translate="filter_all_categories">All Categories</option> </select> 
      </div> 
      <div class="akmtable-responsive"> 
       <table class="akmtable"> 
        <thead> 
         <tr> 
          <th data-translate="table_image">Image</th> 
          <th data-translate="table_name">Name</th> 
          <th data-translate="table_category">Category</th> 
          <th data-translate="table_price">Price</th> 
          <th data-translate="table_actions">Actions</th> 
         </tr> 
        </thead> 
        <tbody id="products-table"> 
        </tbody> 
       </table> 
      </div> 
     </div> 
    </section> 
    <section id="categories-section" class="akmcontent-section" style="display: none;"> 
     <div class="akmcard"> 
      <div class="akmcard-header"> 
       <h2 class="akmcard-title" data-translate="menu_categories">Categories</h2> 
       <div class="akmbtn-group"> <button class="akmbtn akmbtn-primary" type="button" id="add-new-category-btn"><i class="fas fa-plus"></i> <span data-translate="btn_add_category">Add Category</span></button> 
       </div> 
      </div> 
      <div class="akmtable-responsive"> 
       <table class="akmtable"> 
        <thead> 
         <tr> 
          <th data-translate="table_name">Name</th> 
          <th data-translate="table_product_count">Product Count</th> 
          <th data-translate="table_actions">Actions</th> 
         </tr> 
        </thead> 
        <tbody id="categories-table"> 
        </tbody> 
       </table> 
      </div> 
     </div> 
    </section> 
    <section id="expiring-soon-section" class="akmcontent-section" style="display: none;">
        <div class="akmcard">
            <div class="akmcard-header">
                <h2 class="akmcard-title" data-translate="title_expiring_soon_products">Expiring Soon Products</h2>
            </div>
            <div class="akmfilter-controls">
                <div class="akmsearch-box"> <i class="fas fa-search"></i>
                    <input type="text" id="expiring-soon-search-input" data-translate-placeholder="placeholder_search_products">
                </div>
                <select id="expiring-soon-category-filter" class="akmform-control">
                    <option value="all" data-translate="filter_all_categories">All Categories</option>
                </select>
                <div class="akmform-group">
                    <label for="expiring-days-filter" class="akmform-label" style="margin-bottom: 0;"><span data-translate="label_show_expiring_in">Show expiring in:</span></label>
                    <input type="number" id="expiring-days-filter" class="akmform-control" value="7" min="1" style="width: 80px; padding: 8px;">
                </div>
            </div>
            <div class="akmtable-responsive">
                <table class="akmtable">
                    <thead>
                        <tr>
                            <th data-translate="table_product_name">Product Name</th>
                            <th data-translate="table_category">Category</th>
                            <th data-translate="table_quantity">Quantity</th>
                            <th data-translate="table_expiry_date">Expiry Date</th>
                            <th data-translate="table_status">Status</th>
                        </tr>
                    </thead>
                    <tbody id="expiring-soon-table">
                    </tbody>
                </table>
            </div>
        </div>
    </section>
    <section id="purchases-section" class="akmcontent-section" style="display: none;"> 
     <div class="akmcard"> 
      <div class="akmcard-header"> 
       <h2 class="akmcard-title" data-translate="menu_purchases">Purchases</h2> 
       <div class="akmbtn-group">
         <button class="akmbtn akmbtn-primary" type="button" id="add-new-purchase-btn"><i class="fas fa-plus"></i> <span data-translate="btn_add_purchase">Add Purchase</span></button> 
         <button class="akmbtn akmbtn-success" type="button" id="export-purchases-csv-btn"><i class="fas fa-file-csv"></i> CSV</button> 
         <button class="akmbtn akmbtn-danger" type="button" id="export-purchases-pdf-btn"><i class="fas fa-file-pdf"></i> PDF</button> 
       </div> 
      </div> 
      <div class="akmfilter-controls"> 
       <div class="akmfilter-group"> <label data-translate="label_filter_by">Filter by:</label> 
        <div id="purchase-filter-type"> <input type="radio" id="filter-all-purchases" name="purchase-filter-type" value="all" checked> <label for="filter-all-purchases" data-translate="filter_all">All</label> <input type="radio" id="filter-date-purchases" name="purchase-filter-type" value="date"> <label for="filter-date-purchases" data-translate="filter_by_date">By Date</label> <input type="radio" id="filter-month-purchases" name="purchase-filter-type" value="month"> <label for="filter-month-purchases" data-translate="filter_by_month">By Month</label> 
        </div> 
       </div> 
       <div id="purchase-date-filter-group" class="akmfilter-group" style="display: none;"> <label for="purchase-filter-date" data-translate="label_date">Date:</label> 
        <input type="date" id="purchase-filter-date" class="akmform-control"> 
       </div> 
       <div id="purchase-month-filter-group" class="akmfilter-group" style="display: none;"> <label for="purchase-filter-month" data-translate="label_month">Month:</label> <select id="purchase-filter-month" class="akmform-control"></select> <label for="purchase-filter-year" data-translate="label_year">Year:</label> <select id="purchase-filter-year" class="akmform-control"></select> 
       </div> 
       <div class="akmbtn-group"> <button class="akmbtn akmbtn-primary" id="apply-purchase-filter-btn" data-translate="btn_apply_filter">Apply Filter</button> <button class="akmbtn akmbtn-secondary" id="clear-purchase-filter-btn" data-translate="btn_clear_filter">Clear Filter</button> 
       </div> 
      </div> 
      <div class="akmtable-responsive"> 
       <table class="akmtable"> 
        <thead> 
         <tr> 
          <th data-translate="table_product_name">Product Name</th> 
          <th data-translate="table_supplier">Supplier</th> 
          <th data-translate="table_quantity">Quantity</th> 
          <th data-translate="table_unit_cost">Unit Cost</th> 
          <th data-translate="table_total_cost">Total Cost</th> 
          <th data-translate="table_date">Date</th> 
          <th data-translate="table_actions">Actions</th> 
         </tr> 
        </thead> 
        <tbody id="purchases-table"> 
        </tbody> 
       </table> 
      </div> 
     </div> 
    </section> 
    <section id="stock-section" class="akmcontent-section" style="display: none;"> 
     <div class="akmcard"> 
      <div class="akmcard-header"> 
       <h2 class="akmcard-title" data-translate="menu_stock">Stock Management</h2> 
      </div> 
      <div class="akmfilter-controls"> 
       <div class="akmsearch-box"> <i class="fas fa-search"></i> 
        <input type="text" id="stock-search-input" data-translate-placeholder="placeholder_search_stock"> 
       </div> 
       <select id="stock-category-filter" class="akmform-control"> <option value="all" data-translate="filter_all_categories">All Categories</option> </select> 
       <div class="akmfilter-group">
         <input type="checkbox" id="low-stock-filter-checkbox">
         <label for="low-stock-filter-checkbox" data-translate="filter_low_stock_only">Show Low Stock Only</label>
       </div>
      </div> 
      <div class="akmtable-responsive"> 
       <table class="akmtable"> 
        <thead> 
         <tr> 
          <th data-translate="table_product">Product</th> 
          <th data-translate="table_quantity">Quantity</th> 
          <th data-translate="table_low_threshold">Low Threshold</th> 
          <th data-translate="table_status">Status</th> 
         </tr> 
        </thead> 
        <tbody id="stock-table"> 
        </tbody> 
       </table> 
      </div> 
     </div> 
    </section> 
    <section id="settings-section" class="akmcontent-section" style="display: none;"> 
     <div class="akmcard"> 
      <div class="akmcard-header"> 
       <h2 class="akmcard-title" data-translate="menu_settings">Settings</h2> 
      </div> 
      <div class="akmcard-body"> 
       <div class="akmform-group"> <label for="tax-rate-setting" class="akmform-label" data-translate="label_tax_rate">Tax Rate (%)</label> 
        <input type="number" id="tax-rate-setting" class="akmform-control" min="0" step="0.1"> 
       </div> 
       <div class="akmform-group"> <label for="receipt-title-setting" class="akmform-label" data-translate="label_receipt_title">Receipt Title</label> 
        <input type="text" id="receipt-title-setting" class="akmform-control" placeholder="ကောင်းစံ POS"> 
       </div> 
       <div class="akmform-group"> <label for="language-select" class="akmform-label" data-translate="label_language">Language</label> <select id="language-select" class="akmform-control"> <option value="en">English</option> <option value="mm">မြန်မာ</option> <option value="jp">日本語</option> </select> 
       </div> 
       <div class="akmform-group">
        <label for="app-mode-select" class="akmform-label" data-translate="label_app_mode">Application Mode</label>
        <select id="app-mode-select" class="akmform-control">
            <option value="retail" data-translate="mode_retail">Retail Mode</option>
            <option value="bakery" data-translate="mode_bakery">Bakery/Cafe Mode</option>
        </select>
       </div>
       <div class="akmform-group">
         <label for="barcode-scanner-mode-select" class="akmform-label" data-translate="label_mode">Mode</label>
         <select id="barcode-scanner-mode-select" class="akmform-control">
             <option value="off" data-translate="mode_normal">Normal Mode</option>
             <option value="on" data-translate="mode_scanner">Scanner Mode</option>
         </select>
       </div>
       <div class="akmform-group"> <button class="akmbtn akmbtn-primary" type="button" id="save-settings-btn"><i class="fas fa-save"></i> <span data-translate="btn_save_settings">Save Settings</span></button> 
       </div> 
       <hr> 
       <div class="akmprinter-management" style="margin-top: 20px;">
           <h4 data-translate="title_printer_management">Printer Management</h4>
           <div class="akmform-group">
               <label class="akmform-label" data-translate="label_bluetooth_printer">Bluetooth Printer</label>
               <button class="akmbtn akmbtn-info" type="button" id="connect-printer-btn">
                   <i class="fas fa-bluetooth-b"></i> <span data-translate="btn_connect_printer">Connect to Printer</span>
               </button>
               <p id="printer-status" style="font-size: 0.8rem; opacity: 0.7; margin-top: 10px;" data-translate="status_no_printer">Status: No printer connected.</p>
           </div>
       </div>
       <hr>
       <div class="akmdata-management" style="margin-top: 20px;"> 
        <h4 data-translate="title_data_management">Data Management</h4> 
        <div class="akmform-group">
            <label class="akmform-label" data-translate="label_delete_by_date">Delete Data by Date:</label>
            <div class="akmfilter-group">
                <input type="date" id="delete-data-date" class="akmform-control" style="flex-basis: 200px; flex-grow: 1;">
                <button class="akmbtn akmbtn-warning" type="button" id="delete-data-by-date-btn"><i class="fas fa-trash"></i> <span data-translate="btn_delete_data_date">Delete Data for Date</span></button>
            </div>
        </div>
        <div class="akmform-group">
            <label class="akmform-label" data-translate="label_delete_by_month">Delete Data by Month:</label>
            <div class="akmfilter-group">
                <select id="delete-data-month" class="akmform-control"></select>
                <select id="delete-data-year" class="akmform-control"></select>
                <button class="akmbtn akmbtn-warning" type="button" id="delete-data-by-month-btn"><i class="fas fa-trash"></i> <span data-translate="btn_delete_data_month">Delete Data for Month</span></button>
            </div>
        </div>
        <div class="akmform-group" style="margin-top: 20px;">
            <button class="akmbtn akmbtn-danger" type="button" id="reset-data-btn"><i class="fas fa-exclamation-triangle"></i> <span data-translate="btn_reset_all_data">Reset All Data</span></button> 
        </div>
        <p style="font-size: 0.8rem; opacity: 0.7; margin-top: 10px;" data-translate="warning_reset_data">Warning: Resetting data will delete all products, sales, and purchases and cannot be undone.</p> 
       </div> 
      </div> 
     </div> 
    </section> 
    <section id="reports-section" class="akmcontent-section" style="display: none;"> 
     <div class="akmcard"> 
      <div class="akmcard-header"> 
       <h2 class="akmcard-title" data-translate="title_generate_reports">Generate Reports</h2> 
      </div> 
      <div class="akmcard-body"> 
       <div class="akmrow"> 
        <div class="akmcol-md-6"> 
         <div class="akmcard" style="margin-top:0;"> 
          <div class="akmcard-header"> 
           <h3 class="akmcard-title" data-translate="title_daily_report">Daily Report</h3> 
          </div> 
          <div class="akmcard-body"> 
           <div class="akmform-group"> <label for="report-date" class="akmform-label" data-translate="label_select_date">Select Date:</label> 
            <input type="date" id="report-date" class="akmform-control"> 
           </div> <button class="akmbtn akmbtn-primary" type="button" id="generate-report-btn"><i class="fas fa-file-alt"></i> <span data-translate="btn_generate_daily_report">Generate Daily Report</span></button> 
          </div> 
         </div> 
        </div> 
        <div class="akmcol-md-6"> 
         <div class="akmcard" style="margin-top:0;"> 
          <div class="akmcard-header"> 
           <h3 class="akmcard-title" data-translate="title_monthly_report">Monthly Report</h3> 
          </div> 
          <div class="akmcard-body"> 
           <div class="akmform-group"> <label for="report-month" class="akmform-label" data-translate="label_select_month">Select Month:</label> <select id="report-month" class="akmform-control"></select> 
           </div> 
           <div class="akmform-group"> <label for="report-year" class="akmform-label" data-translate="label_select_year">Select Year:</label> <select id="report-year" class="akmform-control"></select> 
           </div> <button class="akmbtn akmbtn-primary" type="button" id="generate-monthly-report-btn"><i class="fas fa-file-alt"></i> <span data-translate="btn_generate_monthly_report">Generate Monthly Report</span></button> 
          </div> 
         </div> 
        </div> 
       </div> 
      </div> 
     </div> 
    </section> 
    <section id="about-section" class="akmcontent-section" style="display: none;"> 
     <div class="akmcard"> 
      <div class="akmcard-header"> 
       <h2 class="akmcard-title" data-translate="menu_about">About</h2> 
      </div> 
      <div class="akmcard-body akmabout-content"> 
       <h3>Amandalori UI</h3> 
       <p data-translate="about_version">Version 3.2 (Bakery/Retail)</p> 
       <p data-translate="about_description">A streamlined and efficient Point of Sale (POS) system built for modern retail businesses. Manage your inventory, process sales, and track your performance with ease.</p> 
       <h3 data-translate="about_features_title">Features</h3> 
       <ul data-translate="about_features_list" data-translate-type="list"> 
        <li>Fast and intuitive sales processing with discount application</li>
        <li>Dual-mode operation: Standard Retail and Bakery/Cafe with expiry tracking</li>
        <li>Comprehensive product and category management with image support</li>
        <li>Real-time inventory tracking with low-stock alerts</li>
        <li>Detailed purchase tracking with flexible cost input (Unit or Total)</li>
        <li>In-depth sale history with filtering and export capabilities (PDF/CSV)</li>
        <li>Customizable settings including tax rates and receipt branding</li>
        <li>Multi-language support for diverse teams</li>
       </ul> 
       <h3>Developer : </h3> 
       <p> Aung Kaung Myat </p> 
      </div> 
     </div> 
    </section> 
   </main> 
  </div> 
  <br> 
  <footer class="akmfooter"> 
   <p>©️ Aung Kaung Myat production</p> 
  </footer> 
  <nav class="akmbottom-nav">
      <a href="#" class="akmbottom-nav-link" data-section="dashboard">
          <i class="fas fa-tachometer-alt"></i>
           </a>
      <a href="#" class="akmbottom-nav-link" data-section="orders">
          <i class="fas fa-cash-register"></i>
          </a>
      <a href="#" class="akmbottom-nav-link" data-section="stock">
          <i class="fas fa-warehouse"></i>
          </a>
  </nav>

  <!-- ============== OTHER MODALS ============== -->
  
  <div class="akmmodal" id="sale-details-modal">
    <div class="akmmodal-dialog">
        <div class="akmmodal-content">
            <div class="akmmodal-header">
                <h3 class="akmmodal-title" data-translate="modal_sale_details_title">Sale Details</h3>
                <button type="button" class="akmmodal-close">×</button>
            </div>
            <div class="akmmodal-body">
                <!-- Content will be injected by JavaScript -->
            </div>
            <div class="akmmodal-footer">
                <button type="button" class="akmbtn akmbtn-secondary akmmodal-close" data-translate="btn_close">Close</button>
            </div>
        </div>
    </div>
  </div>

  <div class="akmmodal" id="product-modal"> 
   <div class="akmmodal-dialog"> 
    <div class="akmmodal-content"> 
     <div class="akmmodal-header"> 
      <h3 class="akmmodal-title" id="product-modal-title" data-translate="modal_add_product_title">Add Product</h3> <button type="button" class="akmmodal-close">×</button> 
     </div> 
     <div class="akmmodal-body"> 
      <form id="product-form"> 
       <input type="hidden" id="product-id"> 
       <div class="akmform-group"> <label for="product-name" class="akmform-label" data-translate="label_product_name">Product Name</label> 
        <input type="text" id="product-name" class="akmform-control" required> 
       </div> 
       <div class="akmform-group"> 
           <label for="product-barcode" class="akmform-label" data-translate="label_product_barcode">Barcode (UPC/EAN)</label> 
           <div class="akm-input-with-btn">
               <input type="text" id="product-barcode" class="akmform-control"> 
               <button type="button" id="scan-product-barcode-btn" class="akmbtn akmbtn-secondary"><i class="fas fa-barcode"></i></button>
           </div>
       </div> 
       <div class="akmform-group"> <label for="product-category" class="akmform-label" data-translate="label_category">Category</label> <select id="product-category" class="akmform-control" required> <option value="" data-translate="placeholder_select_category">Select Category</option> </select> 
       </div> 
       <div class="akmform-group"> <label for="product-price" class="akmform-label" data-translate="label_price">Price</label> 
        <input type="number" id="product-price" class="akmform-control" min="0" step="100" required> 
       </div> 
       <div class="akmform-group"> <label for="product-image-upload" class="akmform-label" data-translate="label_product_image">Product Image</label> 
        <input type="file" id="product-image-upload" class="akmform-control" accept="image/"> 
        <div class="akmimage-upload-container"> 
         <img id="product-image-preview" src="" alt="Image Preview" style="display: none;"> <button type="button" id="remove-image-btn" class="akmbtn akmbtn-sm akmbtn-danger" style="display: none;"><i class="fas fa-times"></i></button> 
        </div> 
       </div> 
      </form> 
     </div> 
     <div class="akmmodal-footer"> <button type="button" class="akmbtn akmbtn-secondary akmmodal-close"><span data-translate="btn_cancel">Cancel</span></button> <button type="button" class="akmbtn akmbtn-danger" id="delete-product-btn" style="display: none;"><i class="fas fa-trash"></i> <span data-translate="btn_delete">Delete</span></button> <button type="button" class="akmbtn akmbtn-primary" id="save-product-btn"><span data-translate="btn_save_product">Save Product</span></button> 
     </div> 
    </div> 
   </div> 
  </div> 
  <div class="akmmodal" id="category-modal"> 
   <div class="akmmodal-dialog"> 
    <div class="akmmodal-content"> 
     <div class="akmmodal-header"> 
      <h3 class="akmmodal-title" id="category-modal-title" data-translate="modal_add_category_title">Add Category</h3> <button type="button" class="akmmodal-close">×</button> 
     </div> 
     <div class="akmmodal-body"> 
      <form id="category-form"> 
       <input type="hidden" id="category-id"> 
       <div class="akmform-group"> <label for="category-name" class="akmform-label" data-translate="label_category_name">Category Name</label> 
        <input type="text" id="category-name" class="akmform-control" required> 
       </div> 
      </form> 
     </div> 
     <div class="akmmodal-footer"> <button type="button" class="akmbtn akmbtn-secondary akmmodal-close"><span data-translate="btn_cancel">Cancel</span></button> <button type="button" class="akmbtn akmbtn-danger" id="delete-category-btn" style="display: none;"><i class="fas fa-trash"></i> <span data-translate="btn_delete">Delete</span></button> <button type="button" class="akmbtn akmbtn-primary" id="save-category-btn"><span data-translate="btn_save">Save</span></button> 
     </div> 
    </div> 
   </div> 
  </div> 
  <div class="akmmodal" id="purchase-modal"> 
   <div class="akmmodal-dialog"> 
    <div class="akmmodal-content"> 
     <div class="akmmodal-header"> 
      <h3 class="akmmodal-title" id="purchase-modal-title" data-translate="modal_add_purchase_title">Add Purchase / Stock</h3> <button type="button" class="akmmodal-close">×</button> 
     </div> 
     <div class="akmmodal-body"> 
      <form id="purchase-form"> 
       <input type="hidden" id="purchase-id"> 
       <div class="akmform-group"> 
           <button type="button" class="akmbtn akmbtn-primary" id="scan-purchase-item-btn" style="width:100%; margin-bottom: 10px;">
                <i class="fas fa-barcode"></i> <span data-translate="btn_add_by_scan">Add by Scan</span>
           </button>
       </div>
       <div class="akmform-group"> <label for="purchase-category" class="akmform-label" data-translate="label_category">Category</label> <select id="purchase-category" class="akmform-control" required> <option value="" data-translate="placeholder_select_category_first">Select Category First</option> </select> 
       </div> 
       <div class="akmform-group"> <label for="purchase-product" class="akmform-label" data-translate="label_product">Product</label> <select id="purchase-product" class="akmform-control" required disabled> <option value="" data-translate="placeholder_select_product">Select a Product</option> </select> 
       </div> 
       <div class="akmform-group"> <label for="purchase-supplier" class="akmform-label" data-translate="label_supplier_optional">Supplier (Optional)</label> 
        <input type="text" id="purchase-supplier" class="akmform-control"> 
       </div> 
       <div class="akmform-group"> <label for="purchase-quantity" class="akmform-label" data-translate="label_quantity">Quantity</label> 
        <input type="number" id="purchase-quantity" class="akmform-control" min="1" required> 
       </div> 
       <div class="akmrow">
         <div class="akmcol-md-6">
            <div class="akmform-group"> <label for="purchase-unit-cost" class="akmform-label" data-translate="label_unit_cost">Unit Cost</label> 
                <input type="number" id="purchase-unit-cost" class="akmform-control" min="0" step="100"> 
            </div> 
         </div>
         <div class="akmcol-md-6">
            <div class="akmform-group"> <label for="purchase-total-cost" class="akmform-label" data-translate="label_total_cost">Total Cost</label> 
                <input type="number" id="purchase-total-cost" class="akmform-control" min="0" step="100"> 
            </div> 
         </div>
       </div>
       <div class="akmform-group"> <label for="purchase-date" class="akmform-label" data-translate="label_date_time">Purchase Date &amp; Time</label> 
        <input type="datetime-local" id="purchase-date" class="akmform-control" required> 
       </div> 
       <div class="akmform-group" id="purchase-expiry-date-group" style="display: none;">
        <label for="purchase-expiry-date" class="akmform-label" data-translate="label_expiry_date">Expiration Date</label>
        <input type="date" id="purchase-expiry-date" class="akmform-control">
       </div>
      </form> 
     </div> 
     <div class="akmmodal-footer"> <button type="button" class="akmbtn akmbtn-secondary akmmodal-close"><span data-translate="btn_cancel">Cancel</span></button> <button type="button" class="akmbtn akmbtn-primary" id="save-purchase-btn"><span data-translate="btn_save_purchase">Save Purchase</span></button> 
     </div> 
    </div> 
   </div> 
  </div> 
  <div class="akmmodal" id="confirm-modal"> 
   <div class="akmmodal-dialog"> 
    <div class="akmmodal-content"> 
     <div class="akmmodal-header"> 
      <h3 class="akmmodal-title" id="confirm-modal-title">Confirm Action</h3> <button type="button" class="akmmodal-close">×</button> 
     </div> 
     <div class="akmmodal-body"> 
      <p id="confirm-message">Are you sure?</p> 
      <div id="reset-confirm-input-container" style="display: none;"> 
       <input type="text" id="reset-confirm-input" class="akmform-control" placeholder=""> 
      </div> 
     </div> 
     <div class="akmmodal-footer"> <button type="button" class="akmbtn akmbtn-secondary akmmodal-close" id="confirm-cancel-btn"><span data-translate="btn_cancel">Cancel</span></button> <button type="button" class="akmbtn akmbtn-danger" id="confirm-ok-btn"><span data-translate="btn_confirm">Confirm</span></button> 
     </div> 
    </div> 
   </div> 
  </div> 
  <div class="akmmodal" id="report-modal"> 
   <div class="akmmodal-dialog"> 
    <div class="akmmodal-content"> 
     <div class="akmmodal-header"> 
      <h3 class="akmmodal-title"><span data-translate="title_report">Report</span> - <span id="report-date-title"></span></h3> <button type="button" class="akmmodal-close">×</button> 
     </div> 
     <div class="akmmodal-body"> 
      <div id="report-content"></div> 
     </div> 
     <div class="akmmodal-footer"> <button type="button" class="akmbtn akmbtn-secondary akmmodal-close"><span data-translate="btn_close">Close</span></button> 
        <button type="button" class="akmbtn akmbtn-primary" id="export-pdf-btn"><i class="fas fa-file-pdf"></i> <span data-translate="btn_export_pdf">Export PDF</span></button> 
        <button type="button" class="akmbtn akmbtn-success" id="export-csv-btn"><i class="fas fa-file-csv"></i> <span data-translate="btn_export_csv">Export CSV</span></button>
     </div> 
    </div> 
   </div> 
  </div> 
  <div class="akmmodal" id="image-viewer-modal"> 
   <div class="akmmodal-dialog"> <button type="button" class="akmmodal-close" style="position: absolute; top: 10px; right: 10px; z-index: 1; font-size: 2rem;">×</button> 
    <img id="full-size-image" src="" alt="Full-size Product Image"> 
   </div> 
  </div> 
  <div class="akmmodal" id="receipt-modal"> 
   <div class="akmmodal-dialog"> 
    <div class="akmmodal-content"> 
     <div class="akmmodal-header"> 
      <h3 class="akmmodal-title" data-translate="modal_sale_completed_title">Sale Completed</h3> <button type="button" class="akmmodal-close">×</button> 
     </div> 
     <div class="akmmodal-body"> 
      <div id="receipt-content"> 
      </div> 
     </div> 
     <div class="akmmodal-footer"> 
         <button type="button" class="akmbtn akmbtn-secondary akmmodal-close"><span data-translate="btn_close">Close</span></button> 
         <button type="button" class="akmbtn akmbtn-info" id="bluetooth-print-btn"><i class="fas fa-bluetooth-b"></i> <span data-translate="btn_print">Print</span></button> 
         <button type="button" class="akmbtn akmbtn-primary" id="print-receipt-btn"><i class="fas fa-save"></i> <span data-translate="btn_save_receipt">Save</span></button> 
         <button type="button" class="akmbtn akmbtn-success" id="share-receipt-btn"><i class="fas fa-share-alt"></i> <span data-translate="btn_share_receipt">Share</span></button> 
     </div> 
    </div> 
   </div> 
  </div> 
  <div class="akmmodal" id="barcode-scanner-modal">
    <div class="akmmodal-dialog">
        <div class="akmmodal-content">
            <div class="akmmodal-header">
                <h3 class="akmmodal-title" data-translate="modal_scan_barcode_title">Scan Barcode</h3>
                <button type="button" class="akmmodal-close">×</button>
            </div>
            <div class="akmmodal-body">
                <div id="barcode-scanner-container"></div>
            </div>
        </div>
    </div>
  </div>
<script type="text/javascript" id="dcoder_script">
document.addEventListener('DOMContentLoaded', () => {
    // --- START: Activation Code Logic ---
    const activationModal = document.getElementById('activation-modal');
    const activationInput = document.getElementById('activation-code-input');
    const activationError = document.getElementById('activation-error');
    const submitActivationBtn = document.getElementById('submit-activation-btn');
    const appContainer = document.querySelector('.akmapp-container');

    function getDynamicActivationCode() {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1; // getMonth() is 0-indexed
        const day = today.getDate();
        const staticKey = 'd939fdj22ef';
        
        const datePart = `${year}${month}${day}`;
        return `${datePart}${staticKey}`;
    }

    function handleActivation() {
        const correctCode = getDynamicActivationCode();
        if (activationInput.value.trim() === correctCode) {
            localStorage.setItem('isAppActivated', 'true');
            activationError.style.display = 'none';
            activationInput.classList.remove('akm-input-error');
            activationModal.classList.remove('akmshow');
            appContainer.classList.add('activated');
            initializeApp(); // Start the main application
        } else {
            activationError.style.display = 'block';
            activationInput.classList.add('akm-input-error');
            activationInput.value = ''; // Clear wrong input
            setTimeout(() => {
                activationInput.classList.remove('akm-input-error');
            }, 500);
        }
    }

    function checkActivation() {
        if (localStorage.getItem('isAppActivated') === 'true') {
            appContainer.classList.add('activated');
            initializeApp();
        } else {
            document.body.className = 'akmdark-mode'; 
            activationModal.classList.add('akmshow');
            activationInput.focus();
            submitActivationBtn.addEventListener('click', handleActivation);
            activationInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    submitActivationBtn.click();
                }
            });
        }
    }
    // --- END: Activation Code Logic ---

    function initializeApp() {
        const DB_NAME = 'dypost073_final';
        const DB_VERSION = 1; 
        let dbInstance;
        let itemToDelete = null;
        let html5QrCodeScanner;
        let onScanSuccessCallback = null;
        let topProductsPieChart = null;
        let connectedPrinter = null;
        let printerCharacteristic = null;
        let lastCompletedOrder = null;

        const openDatabase = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('products')) {
                        const productsStore = db.createObjectStore('products', { keyPath: 'id' });
                        productsStore.createIndex('categoryId', 'categoryId', { unique: false });
                        productsStore.createIndex('name', 'name', { unique: false });
                        productsStore.createIndex('barcode', 'barcode', { unique: true });
                    }
                    if (!db.objectStoreNames.contains('categories')) {
                        db.createObjectStore('categories', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('stock')) {
                        const stockStore = db.createObjectStore('stock', { keyPath: 'productId' });
                        stockStore.createIndex('quantity', 'quantity', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('purchases')) {
                        const purchasesStore = db.createObjectStore('purchases', { keyPath: 'id' });
                        purchasesStore.createIndex('dateTime', 'dateTime', { unique: false });
                        purchasesStore.createIndex('productId', 'productId', { unique: false });
                        purchasesStore.createIndex('expiryDate', 'expiryDate', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('orders')) {
                        const ordersStore = db.createObjectStore('orders', { keyPath: 'id' });
                        ordersStore.createIndex('date', 'date', { unique: false });
                        ordersStore.createIndex('status', 'status', { unique: false });
                        ordersStore.createIndex('paymentMethod', 'paymentMethod', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
                
                request.onsuccess = (event) => {
                    dbInstance = event.target.result;
                    resolve(dbInstance);
                };
                
                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                    reject(event.target.error);
                };
            });
        };

        const db = {
            add: (storeName, item) => new Promise((resolve, reject) => {
                const t = dbInstance.transaction(storeName, 'readwrite');
                t.oncomplete = () => resolve(item);
                t.onerror = event => reject(event.target.error);
                t.objectStore(storeName).add(item);
            }),
            put: (storeName, item) => new Promise((resolve, reject) => {
                const t = dbInstance.transaction(storeName, 'readwrite');
                t.oncomplete = () => resolve(item);
                t.onerror = event => reject(event.target.error);
                t.objectStore(storeName).put(item);
            }),
            get: (storeName, key) => new Promise((resolve, reject) => {
                const t = dbInstance.transaction(storeName, 'readonly');
                const request = t.objectStore(storeName).get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = event => reject(event.target.error);
            }),
            getFromIndex: (storeName, indexName, key) => new Promise((resolve, reject) => {
                const t = dbInstance.transaction(storeName, 'readonly');
                const store = t.objectStore(storeName);
                const index = store.index(indexName);
                const request = index.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = event => reject(event.target.error);
            }),
            getAll: (storeName, indexName, range) => new Promise((resolve, reject) => {
                const store = dbInstance.transaction(storeName, 'readonly').objectStore(storeName);
                const target = indexName ? store.index(indexName) : store;
                const request = range ? target.getAll(range) : target.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = event => reject(event.target.error);
            }),
            delete: (storeName, key) => new Promise((resolve, reject) => {
                const t = dbInstance.transaction(storeName, 'readwrite');
                t.oncomplete = () => resolve();
                t.onerror = event => reject(event.target.error);
                t.objectStore(storeName).delete(key);
            }),
            count: (storeName, indexName, range) => new Promise((resolve, reject) => {
                const store = dbInstance.transaction(storeName, 'readonly').objectStore(storeName);
                const target = indexName ? store.index(indexName) : store;
                const request = range ? target.count(range) : target.count();
                request.onsuccess = () => resolve(request.result);
                request.onerror = event => reject(event.target.error);
            }),
        };

        const initSampleData = async () => {
            const productCount = await db.count('products');
            if (productCount > 0) return;
            
            const categories = [ { id: 'cat1', name: 'Electronics' }, { id: 'cat2', name: 'Apparel' }, { id: 'cat3', name: 'Groceries' }];
            const products = [
                { id: 'prod1', categoryId: 'cat1', name: 'Wireless Mouse', price: 25000, image: null, barcode: '11111111' },
                { id: 'prod2', categoryId: 'cat2', name: 'T-Shirt (M)', price: 15000, image: null, barcode: '22222222' },
                { id: 'prod3', categoryId: 'cat1', name: 'USB-C Cable', price: 8000, image: null, barcode: '33333333' },
                { id: 'prod4', categoryId: 'cat3', name: 'Instant Noodles', price: 1500, image: null, barcode: '44444444' },
            ];
            const stock = products.map(p => ({ productId: p.id, quantity: 50, lowThreshold: 10 }));
            
            try {
                await Promise.all(categories.map(c => db.add('categories', c)));
                await Promise.all(products.map(p => db.add('products', p)));
                await Promise.all(stock.map(s => db.add('stock', s)));

                await db.put('settings', { key: 'theme', value: 'dark' });
                await db.put('settings', { key: 'language', value: 'mm' });
                await db.put('settings', { key: 'taxRate', value: 0 });
                await db.put('settings', { key: 'receiptTitle', value: 'ကောင်းစံ Retail' });
                await db.put('settings', { key: 'appMode', value: 'retail' });
                await db.put('settings', { key: 'barcodeScannerMode', value: 'off' });
            } catch (error) {
                console.error('Error initializing sample data:', error);
            }
        };

        const state = {
            currentSection: 'dashboard',
            currentOrder: null,
            taxRate: 0,
            currentLanguage: 'en',
            appMode: 'retail',
            barcodeScannerMode: 'off',
            filteredPurchases: [],
            reportData: null,
        };

        const UIElements = {
            sidebar: document.querySelector('.akmsidebar'),
            mainContent: document.querySelector('.akmmain-content'),
            menuToggle: document.querySelector('.akmmenu-toggle'),
            themeToggle: document.querySelector('.akmtheme-toggle'),
            sections: document.querySelectorAll('.akmcontent-section'),
            sidebarLinks: document.querySelectorAll('.akmmenu-link'),
            bottomNav: document.querySelector('.akmbottom-nav'),
            bottomNavLinks: document.querySelectorAll('.akmbottom-nav-link'),
            productModal: document.getElementById('product-modal'),
            productsTableBody: document.getElementById('products-table'),
            productsSearchInput: document.getElementById('products-search-input'),
            productCategoryFilter: document.getElementById('product-category-filter'),
            stockTableBody: document.getElementById('stock-table'),
            stockSearchInput: document.getElementById('stock-search-input'),
            stockCategoryFilter: document.getElementById('stock-category-filter'),
            lowStockFilterCheckbox: document.getElementById('low-stock-filter-checkbox'),
            categoriesTableBody: document.getElementById('categories-table'),
            categoryTabs: document.getElementById('category-tabs'),
            productsGrid: document.getElementById('products-grid'),
            currentOrderId: document.getElementById('current-order-id'),
            orderItemsList: document.getElementById('order-items-list'),
            orderSubtotal: document.getElementById('order-subtotal'),
            orderDiscount: document.getElementById('order-discount'),
            orderTax: document.getElementById('order-tax'),
            orderTaxLabel: document.getElementById('order-tax-label'),
            orderTotal: document.getElementById('order-total'),
            completeOrderBtn: document.getElementById('complete-order-btn'),
            cancelOrderBtn: document.getElementById('cancel-order-btn'),
            paymentMethodGroup: document.getElementById('payment-method-group'),
            purchaseModal: document.getElementById('purchase-modal'),
            purchaseCategorySelect: document.getElementById('purchase-category'),
            purchaseProductSelect: document.getElementById('purchase-product'),
            taxRateSetting: document.getElementById('tax-rate-setting'),
            receiptTitleSetting: document.getElementById('receipt-title-setting'),
            languageSelect: document.getElementById('language-select'),
            appModeSelect: document.getElementById('app-mode-select'),
            barcodeScannerModeSelect: document.getElementById('barcode-scanner-mode-select'),
            launchScannerBtn: document.getElementById('launch-scanner-btn'),
            barcodeScannerModal: document.getElementById('barcode-scanner-modal'),
            deleteDataByDateBtn: document.getElementById('delete-data-by-date-btn'),
            deleteDataByMonthBtn: document.getElementById('delete-data-by-month-btn'),
            resetDataBtn: document.getElementById('reset-data-btn'),
            totalOrders: document.getElementById('total-orders'),
            netProfit: document.getElementById('net-profit'),
            salesRevenue: document.getElementById('sales-revenue'),
            lowStockItems: document.getElementById('low-stock-items'),
            reportDate: document.getElementById('report-date'),
            reportModal: document.getElementById('report-modal'),
            reportMonth: document.getElementById('report-month'),
            reportYear: document.getElementById('report-year'),
            purchaseFilterType: document.getElementById('purchase-filter-type'),
            purchaseDateFilterGroup: document.getElementById('purchase-date-filter-group'),
            purchaseMonthFilterGroup: document.getElementById('purchase-month-filter-group'),
            purchaseFilterDate: document.getElementById('purchase-filter-date'),
            purchaseFilterMonth: document.getElementById('purchase-filter-month'),
            purchaseFilterYear: document.getElementById('purchase-filter-year'),
            expiringSoonMenuItem: document.getElementById('expiring-soon-menu-item'),
            expiringSoonTableBody: document.getElementById('expiring-soon-table'),
            expiringSoonSearchInput: document.getElementById('expiring-soon-search-input'),
            expiringSoonCategoryFilter: document.getElementById('expiring-soon-category-filter'),
            expiringDaysFilter: document.getElementById('expiring-days-filter'),
            purchaseExpiryDateGroup: document.getElementById('purchase-expiry-date-group'),
            printerStatus: document.getElementById('printer-status'),
        };

        async function render() {
            UIElements.sections.forEach(sec => sec.style.display = 'none');
            const currentSectionEl = document.getElementById(`${state.currentSection}-section`);
            if (currentSectionEl) {
                currentSectionEl.style.display = 'block';
            }
            
            switch (state.currentSection) {
                case 'dashboard': await renderDashboard(); break;
                case 'products': await renderProductsPage(); break;
                case 'categories': await renderCategoriesPage(); break;
                case 'orders': await renderOrdersPage(); break;
                case 'purchases': await renderPurchasesPage(); break;
                case 'stock': await renderStockPage(); break;
                case 'expiring-soon': await renderExpiringSoonPage(); break;
                case 'settings': await renderSettingsPage(); break;
                case 'reports': await renderReportsPage(); break;
            }

            UIElements.sidebarLinks.forEach(link => {
                link.classList.toggle('akmactive', link.dataset.section === state.currentSection);
            });
            UIElements.bottomNavLinks.forEach(link => {
                link.classList.toggle('akmactive', link.dataset.section === state.currentSection);
            });
        }

        async function renderDashboard() {
            const today = new Date().toISOString().slice(0, 10);
            const range = IDBKeyRange.only(today);
            const todaysOrders = (await db.getAll('orders', 'date', range)).filter(o => o.status === 'completed');
            const todaysPurchases = (await db.getAll('purchases')).filter(p => p.dateTime.startsWith(today));
            const revenue = todaysOrders.reduce((sum, o) => sum + o.total, 0);
            const cost = todaysPurchases.reduce((sum, p) => sum + p.totalCost, 0);
            UIElements.totalOrders.textContent = todaysOrders.length;
            UIElements.salesRevenue.textContent = formatCurrency(revenue);
            UIElements.netProfit.textContent = formatCurrency(revenue - cost);
            
            const allStock = await db.getAll('stock');
            UIElements.lowStockItems.textContent = allStock.filter(s => s.quantity <= s.lowThreshold).length; 
        }
        
        async function renderProductsPage() {
            const searchTerm = UIElements.productsSearchInput.value.toLowerCase();
            const categoryFilter = UIElements.productCategoryFilter.value;
            const allProducts = await db.getAll('products');
            
            const filteredProducts = allProducts.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(searchTerm);
                const matchesCategory = (categoryFilter === 'all' || p.categoryId === categoryFilter);
                return matchesSearch && matchesCategory;
            });

            if (filteredProducts.length === 0 && searchTerm === '' && categoryFilter === 'all') {
                 UIElements.productsTableBody.innerHTML = `<tr><td colspan="5"><div class="akmempty-state"><i class="fas fa-box-open"></i><p>${getTranslation('empty_no_products_yet')}</p></div></td></tr>`;
            } else if (filteredProducts.length === 0) {
                UIElements.productsTableBody.innerHTML = `<tr><td colspan="5"><div class="akmempty-state"><i class="fas fa-search"></i><p>${getTranslation('empty_no_products_match')}</p></div></td></tr>`;
            } else {
                const categories = await db.getAll('categories');
                UIElements.productsTableBody.innerHTML = filteredProducts.map(p => {
                    const category = categories.find(c => c.id === p.categoryId);
                    return `
                        <tr>
                            <td>
                                <img src="${p.image || ''}" class="akmproduct-table-image" alt="Product" data-id="${p.id}" onerror="this.style.display='none'; this.nextSibling.style.display='inline-block'">
                                <i class="fas fa-image" style="display:none; font-size: 24px; color: var(--border-color);"></i>
                            </td>
                            <td>${p.name}</td>
                            <td>${category ? category.name : getTranslation('label_uncategorized')}</td>
                            <td>${formatCurrency(p.price)}</td>
                            <td class="akmaction-buttons">
                                <button class="akmbtn akmbtn-sm akmbtn-outline-primary" data-action="edit-product" data-id="${p.id}"><i class="fas fa-edit"></i></button>
                                <button class="akmbtn akmbtn-sm akmbtn-danger" data-action="delete-product" data-id="${p.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        async function renderCategoriesPage() {
            const [allCategories, products] = await Promise.all([db.getAll('categories'), db.getAll('products')]);
            const tableBody = UIElements.categoriesTableBody;

            if (allCategories.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3"><div class="akmempty-state"><i class="fas fa-tags"></i><p>${getTranslation('empty_no_categories')}</p></div></td></tr>`;
                return;
            }

            tableBody.innerHTML = allCategories.map(c => {
                const productCount = products.filter(p => p.categoryId === c.id).length;
                return `
                    <tr>
                        <td>${c.name}</td>
                        <td>${productCount}</td>
                        <td class="akmaction-buttons">
                            <button class="akmbtn akmbtn-sm akmbtn-outline-primary" data-action="edit-category" data-id="${c.id}"><i class="fas fa-edit"></i></button>
                            <button class="akmbtn akmbtn-sm akmbtn-danger" data-action="delete-category" data-id="${c.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function renderOrdersPage() {
            const categories = await db.getAll('categories');
            UIElements.categoryTabs.innerHTML = `<button class="akmcategory-tab akmactive" data-id="all">${getTranslation('filter_all')}</button>` + 
                categories.map(c => `<button class="akmcategory-tab" data-id="${c.id}">${c.name}</button>`).join('');
            
            await renderProductsGrid('all');
            renderCurrentOrder();
        }
        
        async function renderProductsGrid(categoryId) {
            document.querySelectorAll('.akmcategory-tab').forEach(tab => tab.classList.remove('akmactive'));
            document.querySelector(`.akmcategory-tab[data-id="${categoryId}"]`).classList.add('akmactive');
            
            const [products, stock] = await Promise.all([db.getAll('products'), db.getAll('stock')]);
            const searchTerm = document.getElementById('product-search').value.toLowerCase();

            let productsToShow = (categoryId === 'all') ? products : products.filter(p => p.categoryId === categoryId);

            if(searchTerm){
                productsToShow = productsToShow.filter(p => p.name.toLowerCase().includes(searchTerm));
            }
            
            if (productsToShow.length === 0) {
                UIElements.productsGrid.innerHTML = `<div class="akmempty-state"><i class="fas fa-box-open"></i><p>${getTranslation('empty_no_products_in_category')}</p></div>`;
                return;
            }

            UIElements.productsGrid.innerHTML = productsToShow.map((p) => {
                const stockItem = stock.find(s => s.productId === p.id);
                const isOutOfStock = !stockItem || stockItem.quantity <= 0;
                return `
                    <div class="akmproduct-card ${isOutOfStock ? 'akmdisabled' : ''}" data-id="${p.id}">
                        <div class="akmproduct-image">
                            ${p.image ? `<img src="${p.image}" alt="${p.name}">` : '<i class="fas fa-box"></i>'}
                        </div>
                        <div class="akmproduct-details">
                            <div class="akmproduct-name">${p.name}</div>
                            <div class="akmproduct-price">${formatCurrency(p.price)}</div>
                        </div>
                        ${isOutOfStock ? `<div class="akmout-of-stock">${getTranslation('label_out_of_stock')}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderCurrentOrder() {
            const order = state.currentOrder;
            UIElements.orderTaxLabel.textContent = getTranslation('label_tax_rate_value', { rate: state.taxRate });
            
            if (!order) {
                UIElements.currentOrderId.textContent = '-';
                UIElements.orderItemsList.innerHTML = `<tr><td colspan="4"><div class="akmempty-state" style="padding:10px;"><p style="font-size:0.8rem; margin:0;">${getTranslation('empty_no_items_added')}</p></div></td></tr>`;
                UIElements.orderSubtotal.textContent = formatCurrency(0);
                UIElements.orderDiscount.value = '';
                UIElements.orderTax.textContent = formatCurrency(0);
                UIElements.orderTotal.textContent = formatCurrency(0);
                UIElements.completeOrderBtn.disabled = true;
                UIElements.cancelOrderBtn.disabled = true;
                return;
            }

            UIElements.currentOrderId.textContent = `${order.id.slice(-5)}`;
            UIElements.orderItemsList.innerHTML = order.items.length > 0 ? order.items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>
                        <button class="akmbtn akmbtn-sm akmbtn-secondary" data-action="decrease-qty" data-id="${item.productId}">-</button>
                        <span style="display: inline-block; width: 25px; text-align: center;">${item.quantity}</span>
                        <button class="akmbtn akmbtn-sm akmbtn-secondary" data-action="increase-qty" data-id="${item.productId}">+</button>
                    </td>
                    <td>${formatCurrency(item.price)}</td>
                    <td>${formatCurrency(item.price * item.quantity)}</td>
                </tr>
            `).join('') : `<tr><td colspan="4"><div class="akmempty-state" style="padding:10px;"><p style="font-size:0.8rem; margin:0;">${getTranslation('empty_no_items_added')}</p></div></td></tr>`;

            const subtotal = order.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const discount = parseFloat(UIElements.orderDiscount.value) || 0;
            const taxableAmount = Math.max(0, subtotal - discount);
            const tax = taxableAmount * (state.taxRate / 100);
            const total = taxableAmount + tax;
            
            order.subtotal = subtotal;
            order.discount = discount;
            order.tax = tax;
            order.total = total;

            UIElements.orderSubtotal.textContent = formatCurrency(subtotal);
            UIElements.orderTax.textContent = formatCurrency(tax);
            UIElements.orderTotal.textContent = formatCurrency(total);
            UIElements.completeOrderBtn.disabled = order.items.length === 0;
            UIElements.cancelOrderBtn.disabled = false;
        }

        async function renderPurchasesPage() {
            const tableBody = document.getElementById('purchases-table');
            let allPurchases = await db.getAll('purchases');
            let filteredPurchases = allPurchases;

            const filterType = document.querySelector('input[name="purchase-filter-type"]:checked').value;

            if (filterType === 'date') {
                const date = UIElements.purchaseFilterDate.value;
                if (date) {
                    filteredPurchases = allPurchases.filter(p => p.dateTime.startsWith(date));
                }
            } else if (filterType === 'month') {
                const month = UIElements.purchaseFilterMonth.value;
                const year = UIElements.purchaseFilterYear.value;
                if (month && year) {
                    const monthPadded = month.toString().padStart(2, '0');
                    const filterPrefix = `${year}-${monthPadded}`;
                    filteredPurchases = allPurchases.filter(p => p.dateTime.startsWith(filterPrefix));
                }
            }
            
            state.filteredPurchases = filteredPurchases.sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime));

            if (state.filteredPurchases.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7"><div class="akmempty-state"><i class="fas fa-shopping-cart"></i><p>${getTranslation('empty_no_purchases_for_filter')}</p></div></td></tr>`;
                return;
            }

            tableBody.innerHTML = state.filteredPurchases.map(p => `
                <tr>
                    <td>${p.productName}</td>
                    <td>${p.supplier || '-'}</td>
                    <td>${p.quantity}</td>
                    <td>${formatCurrency(p.unitCost)}</td>
                    <td>${formatCurrency(p.totalCost)}</td>
                    <td>${new Date(p.dateTime).toLocaleString()}</td>
                    <td class="akmaction-buttons">
                        <button class="akmbtn akmbtn-sm akmbtn-danger" data-action="delete-purchase" data-id="${p.id}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function renderStockPage() {
            const [stock, products] = await Promise.all([ db.getAll('stock'), db.getAll('products')]);
            
            const searchTerm = UIElements.stockSearchInput.value.toLowerCase();
            const categoryFilter = UIElements.stockCategoryFilter.value;
            const showLowStockOnly = UIElements.lowStockFilterCheckbox.checked;

            const filteredProducts = products.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(searchTerm);
                const matchesCategory = (categoryFilter === 'all' || p.categoryId === categoryFilter);
                return matchesSearch && matchesCategory;
            });

            const filteredProductIds = new Set(filteredProducts.map(p => p.id));
            let filteredStock = stock.filter(s => filteredProductIds.has(s.productId));

            if (showLowStockOnly) {
                filteredStock = filteredStock.filter(s => s.quantity <= s.lowThreshold);
            }

            if (filteredStock.length === 0) {
                 const messageKey = searchTerm || categoryFilter !== 'all' || showLowStockOnly ? 'empty_no_stock_for_filter' : 'empty_no_stock';
                 UIElements.stockTableBody.innerHTML = `<tr><td colspan="4"><div class="akmempty-state"><i class="fas fa-warehouse"></i><p>${getTranslation(messageKey)}</p></div></td></tr>`;
            } else {
                UIElements.stockTableBody.innerHTML = filteredStock.map(s => {
                    const product = products.find(p => p.id === s.productId);
                    if (!product) return '';
                    const statusClass = s.quantity <= s.lowThreshold ? 'akmlow' : 'akmnormal';
                    const statusText = statusClass === 'akmlow' ? getTranslation('label_low_stock') : getTranslation('label_in_stock');
                    return `
                        <tr>
                            <td>${product.name}</td>
                            <td>${s.quantity}</td>
                            <td>
                                <input type="number" class="akmform-control akmstock-threshold-input" value="${s.lowThreshold}" min="0" data-product-id="${s.productId}">
                            </td>
                            <td><span class="akmstock-status ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                }).join('');
            }
        }

        async function renderExpiringSoonPage() {
            const [allPurchases, products, categories] = await Promise.all([
                db.getAll('purchases'), db.getAll('products'), db.getAll('categories')
            ]);

            const daysFilter = parseInt(UIElements.expiringDaysFilter.value) || 7;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expiryLimit = new Date();
            expiryLimit.setDate(today.getDate() + daysFilter);

            const expiringPurchases = allPurchases.filter(p => {
                if (!p.expiryDate) return false;
                const expiry = new Date(p.expiryDate);
                return expiry >= today && expiry <= expiryLimit;
            });

            const searchTerm = UIElements.expiringSoonSearchInput.value.toLowerCase();
            const categoryFilter = UIElements.expiringSoonCategoryFilter.value;

            const filteredPurchases = expiringPurchases.filter(p => {
                const product = products.find(prod => prod.id === p.productId);
                if (!product) return false;
                const matchesSearch = product.name.toLowerCase().includes(searchTerm);
                const matchesCategory = (categoryFilter === 'all' || product.categoryId === categoryFilter);
                return matchesSearch && matchesCategory;
            });

            if (filteredPurchases.length === 0) {
                const emptyMessage = (searchTerm || categoryFilter !== 'all')
                    ? getTranslation('empty_no_expiring_items_for_filter')
                    : getTranslation('empty_no_expiring_items');
                UIElements.expiringSoonTableBody.innerHTML = `<tr><td colspan="5"><div class="akmempty-state"><i class="fas fa-hourglass-half"></i><p>${emptyMessage}</p></div></td></tr>`;
            } else {
                UIElements.expiringSoonTableBody.innerHTML = filteredPurchases.map(p => {
                    const product = products.find(prod => prod.id === p.productId);
                    const category = categories.find(c => c.id === product.categoryId);
                    return `
                        <tr>
                            <td>${product.name}</td>
                            <td>${category ? category.name : getTranslation('label_uncategorized')}</td>
                            <td>${p.quantity}</td>
                            <td>${p.expiryDate}</td>
                            <td><span class="akmstock-status akmexpiring">${getTranslation('label_expiring_soon')}</span></td>
                        </tr>
                    `;
                }).join('');
            }
        }

        async function renderSettingsPage() {
            const [taxRate, receiptTitle, language, appMode, barcodeMode] = await Promise.all([
                db.get('settings', 'taxRate'),
                db.get('settings', 'receiptTitle'),
                db.get('settings', 'language'),
                db.get('settings', 'appMode'),
                db.get('settings', 'barcodeScannerMode')
            ]);
        
            UIElements.taxRateSetting.value = taxRate ? taxRate.value : 0;
            UIElements.receiptTitleSetting.value = receiptTitle ? receiptTitle.value : 'ကောင်းစံ Retail';
            UIElements.languageSelect.value = language ? language.value : 'mm';
            UIElements.appModeSelect.value = appMode ? appMode.value : 'retail';
            UIElements.barcodeScannerModeSelect.value = barcodeMode ? barcodeMode.value : 'off';
        
            const deleteMonthSelect = document.getElementById('delete-data-month');
            const deleteYearSelect = document.getElementById('delete-data-year');
            
            const monthNames = getTranslation('month_names');
            deleteMonthSelect.innerHTML = monthNames.map((name, index) => `<option value="${index + 1}">${name}</option>`).join('');

            const currentYear = new Date().getFullYear();
            let yearOptions = '';
            for (let i = currentYear + 1; i >= 2023; i--) {
                yearOptions += `<option value="${i}">${i}</option>`;
            }
            deleteYearSelect.innerHTML = yearOptions;
            
            document.getElementById('delete-data-date').valueAsDate = new Date();
        }

        async function renderReportsPage() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;

            let yearOptions = '';
            for (let i = currentYear + 1; i >= 2023; i--) {
                yearOptions += `<option value="${i}" ${i === currentYear ? 'selected' : ''}>${i}</option>`;
            }
            UIElements.reportYear.innerHTML = yearOptions;

            const monthNames = getTranslation('month_names');
            const monthOptions = monthNames.map((name, index) => {
                const monthValue = index + 1;
                return `<option value="${monthValue}" ${monthValue === currentMonth ? 'selected' : ''}>${name}</option>`;
            }).join('');
            UIElements.reportMonth.innerHTML = monthOptions;

            UIElements.reportDate.valueAsDate = new Date();
        }
        
        async function populateFilterDropdowns() {
            const categories = await db.getAll('categories');
            const optionsHtml = `<option value="all" data-translate="filter_all_categories">${getTranslation('filter_all_categories')}</option>` + 
                                categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            const filterSelects = [
                UIElements.productCategoryFilter,
                UIElements.stockCategoryFilter,
                UIElements.expiringSoonCategoryFilter,
            ];

            filterSelects.forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = optionsHtml;
                    select.value = currentValue;
                }
            });
        }

        function populateDynamicFilters() {
            const currentYear = new Date().getFullYear();
            let yearOptions = '';
            for (let i = currentYear + 1; i >= 2023; i--) {
                yearOptions += `<option value="${i}" ${i === currentYear ? 'selected' : ''}>${i}</option>`;
            }
            UIElements.purchaseFilterYear.innerHTML = yearOptions;

            const monthNames = getTranslation('month_names');
            const monthOptions = monthNames.map((name, index) => `<option value="${index + 1}">${name}</option>`).join('');
            UIElements.purchaseFilterMonth.innerHTML = monthOptions;
            
            UIElements.purchaseFilterDate.valueAsDate = new Date();
        }

        function openModal(modalId) { document.getElementById(modalId).classList.add('akmshow'); }
        function closeModal(modalId) { 
            if (modalId === 'barcode-scanner-modal' && html5QrCodeScanner && html5QrCodeScanner.getState() === 2) { // 2: SCANNING
                html5QrCodeScanner.stop().catch(err => console.error("Error stopping scanner:", err));
            }
            document.getElementById(modalId).classList.remove('akmshow'); 
        }
        
        function showConfirmation({ title, message, onConfirm, okText = 'btn_confirm', isDanger = true, requiresInput = false, inputPlaceholder = '' }) {
            const modal = document.getElementById('confirm-modal');
            modal.querySelector('#confirm-modal-title').textContent = title;
            modal.querySelector('#confirm-message').textContent = message;

            const okBtn = modal.querySelector('#confirm-ok-btn');
            okBtn.innerHTML = `<span data-translate="${okText}">${getTranslation(okText)}</span>`;
            okBtn.className = `akmbtn ${isDanger ? 'akmbtn-danger' : 'akmbtn-primary'}`;
            
            const inputContainer = modal.querySelector('#reset-confirm-input-container');
            const inputField = modal.querySelector('#reset-confirm-input');
            inputContainer.style.display = requiresInput ? 'block' : 'none';
            if (requiresInput) {
                inputField.value = '';
                inputField.placeholder = inputPlaceholder;
            }

            openModal('confirm-modal');

            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);

            newOkBtn.addEventListener('click', () => {
                onConfirm(requiresInput ? inputField.value : undefined);
            });
        }

        async function toggleTheme() {
            const body = document.body;
            const newTheme = body.classList.contains('akmdark-mode') ? 'light' : 'dark';
            await db.put('settings', { key: 'theme', value: newTheme });
            applyTheme();
        }
        
        async function applyTheme() {
            const themeSetting = await db.get('settings', 'theme');
            const theme = themeSetting ? themeSetting.value : 'dark';
            document.body.className = `akm${theme}-mode`;
            UIElements.themeToggle.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }

        function applyAppMode(mode) {
            state.appMode = mode;
            const isBakery = mode === 'bakery';

            UIElements.expiringSoonMenuItem.style.display = isBakery ? 'block' : 'none';
            UIElements.purchaseExpiryDateGroup.style.display = isBakery ? 'block' : 'none';

            if (!isBakery && state.currentSection === 'expiring-soon') {
                state.currentSection = 'dashboard';
                render();
            }
        }

        function applyBarcodeScannerMode(mode) {
            state.barcodeScannerMode = mode;
            UIElements.launchScannerBtn.style.display = mode === 'on' ? 'inline-flex' : 'none';
        }

        function formatCurrency(amount) { 
            const lang = state.currentLanguage;
            if (lang === 'jp') {
                return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(amount);
            }
            return new Intl.NumberFormat('en-US').format(amount) + ' ကျပ်';
        }

        const translations = {
            label_tax_rate_value: { en: "Tax ({rate}%)", mm: "အခွန် ({rate}%)", jp: "税金 ({rate}%)" },
            payment_cash: { en: "Cash", mm: "ငွေသား", jp: "現金" },
            payment_card: { en: "Card", mm: "ကတ်", jp: "カード" },
            payment_kbzpay: { en: "KBZ Pay", mm: "KBZ Pay", jp: "KBZ Pay" },
            payment_method: { en: "Payment Method", mm: "ငွေပေးချေမှုပုံစံ", jp: "支払方法" },
            btn_add_by_scan: { en: "Add by Scan", mm: "Scan ဖတ်၍ထည့်မည်", jp: "スキャンで追加" },
            title_printer_management: { en: "Printer Management", mm: "ပရင်တာ စီမံခန့်ခွဲမှု", jp: "プリンター管理" },
            label_bluetooth_printer: { en: "Bluetooth Printer", mm: "ဘလူးတုသ် ပရင်တာ", jp: "Bluetoothプリンター" },
            btn_connect_printer: { en: "Connect to Printer", mm: "ပရင်တာနှင့်ချိတ်ဆက်ပါ", jp: "プリンターに接続" },
            status_no_printer: { en: "Status: No printer connected.", mm: "အခြေအနေ: ပရင်တာချိတ်ဆက်ထားခြင်းမရှိပါ။", jp: "ステータス：プリンターが接続されていません。" },
            status_printer_connected: { en: "Status: Connected to {printerName}", mm: "အခြေအနေ: {printerName} နှင့်ချိတ်ဆက်ထားပါသည်", jp: "ステータス：{printerName}に接続済み" },
            status_connecting_printer: { en: "Status: Connecting...", mm: "အခြေအနေ: ချိတ်ဆက်နေသည်...", jp: "ステータス：接続中..." },
            status_printer_disconnected: { en: "Status: Printer disconnected.", mm: "အခြေအနေ: ပရင်တာအဆက်အသွယ်ပြတ်တောက်သွားသည်။", jp: "ステータス：プリンターが切断されました。" },
            alert_bt_unavailable: { en: "Web Bluetooth is not available on this browser. Please use Chrome on Android, Mac, or Windows.", mm: "ဤဘရောက်ဇာတွင် Web Bluetooth ကို အသုံးမပြုနိုင်ပါ။ Android, Mac, သို့မဟုတ် Windows ပေါ်ရှိ Chrome ကို အသုံးပြုပါ။", jp: "このブラウザではWeb Bluetoothは利用できません。Android、Mac、またはWindowsでChromeを使用してください。" },
            alert_bt_connect_fail: { en: "Failed to connect to the printer.", mm: "ပရင်တာနှင့်ချိတ်ဆက်ရန်မအောင်မြင်ပါ။", jp: "プリンターへの接続に失敗しました。" },
            alert_bt_print_fail: { en: "Failed to print. Make sure the printer is connected and on.", mm: "ပုံနှိပ်ရန်မအောင်မြင်ပါ။ ပရင်တာချိတ်ဆက်ထားပြီး ဖွင့်ထားကြောင်းသေချာပါစေ။", jp: "印刷に失敗しました。プリンターが接続され、電源が入っていることを確認してください。" },
            btn_save_receipt: { en: "Save", mm: "သိမ်းမည်", jp: "保存" },
            modal_sale_details_title: { en: "Sale Details", mm: "အရောင်းအသေးစိတ်", jp: "販売詳細" },
            menu_main: { en: "Main", mm: "ပင်မ", jp: "メイン" },
            menu_dashboard: { en: "Dashboard", mm: "ဒိုင်ခွက်", jp: "ダッシュボード" },
            menu_new_sale: { en: "New Sale", mm: "အရောင်းသစ်", jp: "新規販売" },
            menu_management: { en: "Management", mm: "စီမံခန့်ခွဲမှု", jp: "管理" },
            menu_products: { en: "Products", mm: "ကုန်ပစ္စည်းများ", jp: "製品" },
            menu_categories: { en: "Categories", mm: "အမျိုးအစားများ", jp: "カテゴリー" },
            menu_stock: { en: "Stock", mm: "ကုန်ပစ္စည်းလက်ကျန်", jp: "在庫" },
            menu_expiring_soon: { en: "Expiring Soon", mm: "ကုန်ဆုံးရက်နီး", jp: "期限間近" },
            menu_purchases: { en: "Purchases", mm: "အဝယ်စာရင်း", jp: "仕入れ" },
            menu_reports: { en: "Reports", mm: "အစီရင်ခံစာများ", jp: "レポート" },
            menu_reports_link: { en: "Reports", mm: "အစီရင်ခံစာများ", jp: "レポート" },
            menu_about: { en: "About", mm: "အချက်အလက်", jp: "概要" },
            menu_settings: { en: "Settings", mm: "ဆက်တင်များ", jp: "設定" },
            label_tax_rate: { en: "Tax Rate (%)", mm: "အခွန်နှုန်း (%)", jp: "税率 (%)" },
            label_receipt_title: { en: "Receipt Title", mm: "ဘောင်ချာခေါင်းစဉ်", jp: "レシートのタイトル" },
            label_app_mode: { en: "Application Mode", mm: "စနစ်အမျိုးအစား", jp: "アプリケーションモード" },
            mode_retail: { en: "Retail Mode", mm: "လက်လီအရောင်းစနစ်", jp: "小売モード" },
            mode_bakery: { en: "Bakery Mode", mm: "ဘေကာရီစနစ်", jp: "ベーカリー モード" },
            label_mode: { en: "Mode", mm: "မုဒ်", jp: "モード" },
            mode_scanner: { en: "Scanner Mode", mm: "စကင်နာမုဒ်", jp: "スキャナーモード" },
            mode_normal: { en: "Normal Mode", mm: "ပုံမှန်မုဒ်", jp: "通常モード" },
            alert_barcode_required: { en: "Barcode is required in Scanner Mode.", mm: "စကင်နာမုဒ်တွင် ဘားကုဒ် လိုအပ်ပါသည်။", jp: "スキャナーモードではバーコードが必要です。" },
            label_delete_by_month: { en: "Delete Data by Month:", mm: "လအလိုက် Data ဖျက်ရန်:", jp: "月別にデータを削除:" },
            btn_delete_data_month: { en: "Delete Data for Month", mm: "လအတွက် Data ဖျက်မည်", jp: "月別データ削除" },
            confirm_delete_data_for_month_msg: { en: "Are you sure you want to delete all sales and purchase records for {monthName} {year}? Stock will be adjusted accordingly. This action cannot be undone.", mm: "{year} ခုနှစ်၊ {monthName} လအတွက် အရောင်းနှင့်အဝယ်မှတ်တမ်းအားလုံးကို ဖျက်မှာသေချာလား? ကုန်ပစ္စည်းလက်ကျန်များကိုလည်း ပြန်လည်ညှိနှိုင်းပါမည်။ ဤလုပ်ဆောင်ချက်ကိုပြန်ပြင်၍မရပါ။", jp: "本当に{year}年{monthName}のすべての売上および仕入記録を削除しますか？在庫はそれに応じて調整されます。この操作は元に戻せません。" },
            alert_data_deleted_for_month: { en: "All sales and purchase data for {monthName} {year} has been deleted and stock reconciled.", mm: "{year} ခုနှစ်၊ {monthName} လအတွက် အရောင်းနှင့်အဝယ်ဒေတာအားလုံးကို ဖျက်ပြီး ကုန်ပစ္စည်းလက်ကျန်များကို ညှိနှိုင်းပြီးပါပြီ။", jp: "{year}年{monthName}のすべての売上および仕入データが削除され、在庫が調整されました。" },
            label_delete_by_date: { en: "Delete Data by Date:", mm: "ရက်စွဲအလိုက် Data ဖျက်ရန်:", jp: "日付別にデータを削除:" },
            btn_delete_data_date: { en: "Delete Data for Date", mm: "ရက်စွဲအတွက် Data ဖျက်မည်", jp: "日付のデータを削除" },
            confirm_delete_data_for_date_msg: { en: "Are you sure you want to delete all sales and purchase records for {date}? Stock will be adjusted accordingly. This action cannot be undone.", mm: "{date} ရက်နေ့အတွက် အရောင်းနှင့်အဝယ်မှတ်တမ်းအားလုံးကို ဖျက်မှာသေချာလား? ကုန်ပစ္စည်းလက်ကျန်များကိုလည်း ပြန်လည်ညှိနှိုင်းပါမည်။ ဤလုပ်ဆောင်ချက်ကိုပြန်ပြင်၍မရပါ။", jp: "本当に{date}のすべての売上および仕入記録を削除しますか？在庫はそれに応じて調整されます。この操作は元に戻せません。" },
            alert_data_deleted_for_date: { en: "All sales and purchase data for {date} has been deleted and stock reconciled.", mm: "{date} ရက်နေ့အတွက် အရောင်းနှင့်အဝယ်ဒေတာအားလုံးကို ဖျက်ပြီး ကုန်ပစ္စည်းလက်ကျန်များကို ညှိနှိုင်းပြီးပါပြီ။", jp: "{date}のすべての売上および仕入データが削除され、在庫が調整されました。" },
            alert_error_deleting_data: { en: "An error occurred while deleting data.", mm: "ဒေတာဖျက်ရာတွင် အမှားအယွင်းဖြစ်ပွားခဲ့သည်။", jp: "データの削除中にエラーが発生しました。" },
            title_expiring_soon_products: { en: "Expiring Soon Products", mm: "ကုန်ဆုံးရက်နီး ကုန်ပစ္စည်းများ", jp: "期限間近の製品" },
            label_expiry_date: { en: "Expiration Date", mm: "ကုန်ဆုံးရက်", jp: "有効期限" },
            label_show_expiring_in: { en: "Show expiring in (days):", mm: "ရက်အတွင်းကုန်ဆုံးမည့်:", jp: "期限切れ表示（日）:" },
            table_expiry_date: { en: "Expiry Date", mm: "ကုန်ဆုံးရက်", jp: "有効期限" },
            empty_no_expiring_items: { en: "No items are expiring soon.", mm: "ကုန်ဆုံးရက်နီး ပစ္စည်းများ မရှိပါ။", jp: "まもなく期限切れになる商品はありません。" },
            empty_no_expiring_items_for_filter: { en: "No expiring items match your filter.", mm: "သင်၏ရှာဖွေမှုနှင့်ကိုက်ညီသော ကုန်ဆုံးရက်နီးပစ္စည်းမရှိပါ။", jp: "フィルターに一致する期限切れ間近の商品はありません。" },
            label_expiring_soon: { en: "Expiring Soon", mm: "ကုန်ဆုံးတော့မည်", jp: "期限間近" },
            about_version: { en: "Version 3.2 (Bakery/Retail)", mm: "ဗားရှင်း ၃.၂ (Bakery/Retail)", jp: "バージョン 3.2 (Bakery/Retail)" },
            about_description: { en: "A streamlined and efficient Point of Sale (POS) system built for modern retail businesses. Manage your inventory, process sales, and track your performance with ease.", mm: "ခေတ်မီလက်လီလုပ်ငန်းများအတွက် တည်ဆောက်ထားသော ရိုးရှင်းပြီး ထိရောက်သည့် အရောင်းစီမံခန့်ခွဲမှုစနစ် (POS) ဖြစ်ပါသည်။ ကုန်ပစ္စည်းစာရင်း၊ အရောင်းအဝယ်နှင့် လုပ်ငန်းဆောင်ရွက်ချက်များကို လွယ်ကူစွာ စီမံခန့်ခွဲပါ။", jp: "現代の小売業向けに構築された、効率的で合理化されたPOSシステムです。在庫管理、販売処理、業績追跡を簡単に行えます。" },
            about_features_title: { en: "Features", mm: "အဓိကလုပ်ဆောင်ချက်များ", jp: "主な機能" },
            about_features_list: {
                en: `<li>Fast and intuitive sales processing with discount application</li><li>Dual-mode operation: Standard Retail and Bakery/Cafe with expiry tracking</li><li>Comprehensive product and category management with image support</li><li>Real-time inventory tracking with low-stock alerts</li><li>Detailed purchase tracking with flexible cost input (Unit or Total)</li><li>In-depth sale history with filtering and export capabilities (PDF/CSV)</li><li>Customizable settings including tax rates and receipt branding</li><li>Multi-language support for diverse teams</li>`,
                mm: `<li>ဈေးလျှော့စနစ်ပါဝင်သော လျင်မြန်သည့် အရောင်းလုပ်ငန်းစဉ်</li><li>စနစ်နှစ်မျိုးသုံးနိုင်ခြင်း- လက်လီစနစ် နှင့် ကုန်ဆုံးရက်ပါ ဘေကာရီ</li><li>ပုံနှင့်တကွ ပြည့်စုံသော ကုန်ပစ္စည်းနှင့်အမျိုးအစား စီမံခန့်ခွဲမှု</li><li>ကုန်ပစ္စည်းလက်ကျန်နည်းပါက အချက်ပေးသည့် Real-time စနစ်</li><li>တစ်ခုချင်းဈေး (သို့) စုစုပေါင်းဈေးဖြင့် ထည့်နိုင်သည့် အဝယ်စာရင်း</li><li>စစ်ထုတ်ခြင်း၊ PDF/CSV ထုတ်ခြင်းတို့ပါဝင်သည့် အရောင်းမှတ်တမ်း</li><li>အခွန်နှင့် ဘောင်ချာများကို စိတ်ကြိုက်ပြင်ဆင်နိုင်ခြင်း</li><li>ဘာသာစကားမျိုးစုံဖြင့် အသုံးပြုနိုင်ခြင်း</li>`,
                jp: `<li>割引適用機能を備えた迅速で直感的な販売処理</li><li>デュアルモード操作：標準小売および有効期限追跡付きベーカリー/カフェ</li><li>画像対応の包括的な製品およびカテゴリ管理</li><li>在庫僅少アラート付きのリアルタイム在庫追跡</li><li>柔軟なコスト入力（単価または合計）による詳細な仕入追跡</li><li>フィルタリングおよびエクスポート機能（PDF / CSV）付きの詳細な販売履歴</li><li>税率やレシートのブランディングなど、カスタマイズ可能な設定</li><li>多様なチームに対応する多言語サポート</li>`,
            },
            dashboard_title: { en: "Today's Overview", mm: "ယနေ့ခြုံငုံသုံးသပ်ချက်", jp: "今日の概要" },
            stat_sales_today: { en: "Sales Today", mm: "ယနေ့ရောင်းအား", jp: "今日の売上" },
            stat_todays_profit: { en: "Today's Profit", mm: "ယနေ့အမြတ်", jp: "今日の利益" },
            stat_sales_revenue: { en: "Sales Revenue", mm: "ရောင်းရငွေ", jp: "売上収益" },
            stat_low_stock: { en: "Low Stock Items", mm: "ကုန်နီးသောပစ္စည်းများ", jp: "在庫僅少品" },
            title_weekly_sales_trend: { en: "Weekly Sales Trend", mm: "တစ်ပတ်အတွင်း ရောင်းအား", jp: "週間売上動向" },
            orders_add_items: { en: "Add Items", mm: "ပစ္စည်းထည့်ရန်", jp: "商品を追加" },
            label_sale: { en: "Sale", mm: "အရောင်း", jp: "販売" },
            label_subtotal: { en: "Subtotal", mm: "စုစုပေါင်း", jp: "小計" },
            label_discount: { en: "Discount", mm: "လျှော့ဈေး", jp: "割引" },
            label_grand_total: { en: "Grand Total", mm: "ကျသင့်ငွေ", jp: "合計金額" },
            table_image: { en: "Image", mm: "ပုံ", jp: "画像" },
            table_name: { en: "Name", mm: "အမည်", jp: "名前" },
            table_category: { en: "Category", mm: "အမျိုးအစား", jp: "カテゴリー" },
            table_price: { en: "Price", mm: "ဈေးနှုန်း", jp: "価格" },
            table_actions: { en: "Actions", mm: "လုပ်ဆောင်ချက်", jp: "操作" },
            table_product_count: { en: "Product Count", mm: "ပစ္စည်းအရေအတွက်", jp: "製品数" },
            table_product_name: { en: "Product Name", mm: "ကုန်ပစ္စည်းအမည်", jp: "製品名" },
            table_supplier: { en: "Supplier", mm: "ပစ္စည်းသွင်းသူ", jp: "サプライヤー" },
            table_quantity: { en: "Quantity", mm: "အရေအတွက်", jp: "数量" },
            table_unit_cost: { en: "Unit Cost", mm: "တစ်ခုချင်းကုန်ကျစရိတ်", jp: "単価" },
            table_total_cost: { en: "Total Cost", mm: "စုစုပေါင်းကုန်ကျစရိတ်", jp: "総費用" },
            table_date: { en: "Date", mm: "ရက်စွဲ", jp: "日付" },
            table_product: { en: "Product", mm: "ကုန်ပစ္စည်း", jp: "製品" },
            table_low_threshold: { en: "Low Threshold", mm: "အနည်းဆုံးသတ်မှတ်ချက်", jp: "下限閾値" },
            table_status: { en: "Status", mm: "အခြေအနေ", jp: "ステータス" },
            modal_sale_completed_title: { en: "Sale Completed", mm: "အရောင်းပြီးမြောက်ပါသည်", jp: "販売完了" },
            entity_sale: { en: "sale record", mm: "အရောင်းမှတ်တမ်း", jp: "販売記録" },
            btn_new_sale: { en: "New Sale", mm: "အရောင်းသစ်", jp: "新規販売" },
            btn_export_csv_short: { en: "CSV", mm: "CSV", jp: "CSV" },
            btn_export_pdf_short: { en: "PDF", mm: "PDF", jp: "PDF" },
            label_language: { en: "Language", mm: "ဘာသာစကား", jp: "言語" },
            title_data_management: { en: "Data Management", mm: "ဒေတာစီမံခန့်ခွဲမှု", jp: "データ管理" },
            title_generate_reports: { en: "Generate Reports", mm: "အစီရင်ခံစာထုတ်ရန်", jp: "レポートの生成" },
            title_daily_report: { en: "Daily Report", mm: "နေ့စဉ်အစီရင်ခံစာ", jp: "日次レポート" },
            label_select_date: { en: "Select Date:", mm: "ရက်စွဲရွေးပါ:", jp: "日付を選択:" },
            title_monthly_report: { en: "Monthly Report", mm: "လစဉ်အစီရင်ခံစာ", jp: "月次レポート" },
            label_select_month: { en: "Select Month:", mm: "လရွေးပါ:", jp: "月を選択:" },
            label_select_year: { en: "Select Year:", mm: "နှစ်ရွေးပါ:", jp: "年を選択:" },
            modal_add_product_title: { en: "Add Product", mm: "ပစ္စည်းအသစ်ထည့်ရန်", jp: "製品の追加" },
            modal_edit_product_title: { en: "Edit Product", mm: "ပစ္စည်းအချက်အလက်ပြင်ရန်", jp: "製品の編集" },
            modal_add_category_title: { en: "Add Category", mm: "အမျိုးအစားသစ်ထည့်ရန်", jp: "カテゴリーの追加" },
            modal_edit_category_title: { en: "Edit Category", mm: "အမျိုးအစားအမည်ပြင်ရန်", jp: "カテゴリーの編集" },
            modal_add_purchase_title: { en: "Add Purchase / Stock", mm: "အဝယ်စာရင်း/ကုန်ပစ္စည်းထည့်ရန်", jp: "仕入れ/在庫の追加" },
            modal_scan_barcode_title: { en: "Scan Barcode", mm: "ဘားကုဒ်ဖတ်ရန်", jp: "バーコードをスキャン" },
            modal_confirm_delete_title: { en: "Confirm Deletion", mm: "ဖျက်ရန်အတည်ပြုပါ", jp: "削除の確認" },
            title_report: { en: "Report", mm: "အစီရင်ခံစာ", jp: "レポート" },
            label_product_name: { en: "Product Name", mm: "ပစ္စည်းအမည်", jp: "製品名" },
            label_product_barcode: { en: "Barcode (UPC/EAN)", mm: "ဘားကုဒ် (UPC/EAN)", jp: "バーコード (UPC/EAN)" },
            label_category: { en: "Category", mm: "အမျိုးအစား", jp: "カテゴリー" },
            label_price: { en: "Price", mm: "ဈေးနှုန်း", jp: "価格" },
            label_product_image: { en: "Product Image", mm: "ပစ္စည်းပုံ", jp: "製品画像" },
            label_category_name: { en: "Category Name", mm: "အမျိုးအစားအမည်", jp: "カテゴリー名" },
            label_product: { en: "Product", mm: "ကုန်ပစ္စည်း", jp: "製品" },
            label_supplier_optional: { en: "Supplier (Optional)", mm: "ပစ္စည်းသွင်းသူ (ထည့်လိုလျှင်)", jp: "サプライヤー (任意)" },
            label_quantity: { en: "Quantity", mm: "အရေအတွက်", jp: "数量" },
            label_date_time: { en: "Purchase Date & Time", mm: "အဝယ် ရက်စွဲနှင့်အချိန်", jp: "購入日時" },
            btn_add_product: { en: "Add Product", mm: "ပစ္စည်းထည့်ရန်", jp: "製品追加" },
            btn_add_category: { en: "Add Category", mm: "အမျိုးအစားထည့်ရန်", jp: "カテゴリ追加" },
            btn_add_purchase: { en: "Add Purchase", mm: "အဝယ်ထည့်ရန်", jp: "仕入追加" },
            btn_complete: { en: "Complete", mm: "ပြီးပြီ", jp: "完了" },
            btn_cancel: { en: "Cancel", mm: "မလုပ်တော့ပါ", jp: "キャンセル" },
            btn_confirm: { en: "Confirm", mm: "အတည်ပြုသည်", jp: "確認" },
            btn_save_settings: { en: "Save Settings", mm: "ဆက်တင်များသိမ်းမည်", jp: "設定を保存" },
            btn_reset_all_data: { en: "Reset All Data", mm: "အားလုံးပြန်ဖျက်မည်", jp: "全データリセット" },
            btn_generate_daily_report: { en: "Generate Daily Report", mm: "နေ့စဉ် Report ထုတ်မည်", jp: "日次レポート生成" },
            btn_generate_monthly_report: { en: "Generate Monthly Report", mm: "လစဉ် Report ထုတ်မည်", jp: "月次レポート生成" },
            btn_delete: { en: "Delete", mm: "ဖျက်မည်", jp: "削除" },
            btn_save_product: { en: "Save Product", mm: "ပစ္စည်းသိမ်းမည်", jp: "製品を保存" },
            btn_save: { en: "Save", mm: "သိမ်းမည်", jp: "保存" },
            btn_save_purchase: { en: "Save Purchase", mm: "အဝယ်သိမ်းမည်", jp: "仕入を保存" },
            btn_close: { en: "Close", mm: "ပိတ်မည်", jp: "閉じる" },
            btn_export_pdf: { en: "Export PDF", mm: "PDF ထုတ်မည်", jp: "PDFでエクスポート" },
            btn_export_csv: { en: "Export CSV", mm: "CSV ထုတ်မည်", jp: "CSVでエクスポート" },
            btn_print: { en: "Print", mm: "ပုံနှိပ်မည်", jp: "印刷" },
            btn_share_receipt: { en: "Share", mm: "မျှဝေမည်", jp: "共有" },
            btn_sharing: { en: "Sharing...", mm: "မျှဝေနေသည်...", jp: "共有中..." },
            placeholder_search_products: { en: "Search products...", mm: "ပစ္စည်းများရှာရန်...", jp: "製品を検索..." },
            placeholder_search_stock: { en: "Search products in stock...", mm: "လက်ကျန်ရှိပစ္စည်းရှာရန်...", jp: "在庫品を検索..." },
            placeholder_select_category: { en: "Select Category", mm: "အမျိုးအစားရွေးပါ", jp: "カテゴリーを選択" },
            placeholder_select_category_first: { en: "Select Category First", mm: "ဦးစွာအမျိုးအစားရွေးပါ", jp: "まずカテゴリーを選択" },
            placeholder_select_product: { en: "Select a Product", mm: "ပစ္စည်းတစ်ခုရွေးပါ", jp: "製品を選択" },
            empty_select_table: { en: "Select an item to begin", mm: "စတင်ရန် ပစ္စည်းတစ်ခုရွေးပါ", jp: "開始するには商品を選択してください" },
            empty_no_items_added: { en: "No items added", mm: "ပစ္စည်းမထည့်ရသေးပါ", jp: "商品が追加されていません" },
            empty_no_products_yet: { en: "No products exist yet. Add one to get started!", mm: "ကုန်ပစ္စည်းများ မရှိသေးပါ။ စတင်ရန် တစ်ခုထည့်ပါ။", jp: "製品がまだありません。追加して始めましょう！" },
            empty_no_products_match: { en: "No products match your search.", mm: "သင်၏ရှာဖွေမှုနှင့် ကိုက်ညီသော ကုန်ပစ္စည်းမရှိပါ။", jp: "検索に一致する製品はありません。" },
            empty_no_categories: { en: "No categories found", mm: "အမျိုးအစားများမတွေ့ပါ", jp: "カテゴリーが見つかりません" },
            empty_no_purchases: { en: "No purchases found", mm: "အဝယ်စာရင်းများမတွေ့ပါ", jp: "仕入れが見つかりません" },
            empty_no_stock: { en: "No stock records found", mm: "ကုန်လက်ကျန်မှတ်တမ်းမတွေ့ပါ", jp: "在庫記録が見つかりません" },
            empty_no_products_in_category: { en: "No products in this category", mm: "ဤအမျိုးအစားတွင် ပစ္စည်းမရှိပါ", jp: "このカテゴリーに製品はありません" },
            empty_no_purchases_for_filter: { en: "No purchases found for the selected filter.", mm: "ရှာဖွေမှုနှင့်ကိုက်ညီသော အဝယ်စာရင်းမတွေ့ပါ။", jp: "選択したフィルターに該当する仕入れはありません。" },
            empty_no_stock_for_filter: { en: "No stock records found for this filter", mm: "ရှာဖွေမှုနှင့်ကိုက်ညီသော ကုန်လက်ကျန်မတွေ့ပါ။", jp: "このフィルターに該当する在庫記録はありません。" },
            warning_reset_data: { en: "Warning: Resetting data will delete all products, sales, and purchases and cannot be undone.", mm: "သတိပေးချက်- ဒေတာအားလုံးကိုပြန်ဖျက်ခြင်းသည် ကုန်ပစ္စည်း၊ အရောင်းနှင့် အဝယ်စာရင်းအားလုံးကို ဖျက်ပစ်မည်ဖြစ်ပြီး ပြန်လည်ရယူနိုင်မည်မဟုတ်ပါ။", jp: "警告: データをリセットすると、すべての製品、売上、仕入れが削除され、元に戻すことはできません。" },
            confirm_cancel_active_order: { en: "There is an active sale. Starting a new one will clear the current items. Continue?", mm: "လက်ရှိအရောင်းတစ်ခုရှိနေပါသည်။ အသစ်စတင်ပါက လက်ရှိပစ္စည်းများ ပယ်ဖျက်သွားမည်ဖြစ်သည်။ ရှေ့ဆက်လုပ်ဆောင်မှာလား?", jp: "有効な販売があります。新しい販売を開始すると、現在の項目はクリアされます。続行しますか？" },
            alert_out_of_stock: { en: "{productName} is out of stock!", mm: "{productName} ကုန်ပစ္စည်း ကုန်သွားပါပြီ!", jp: "{productName}は在庫切れです！" },
            alert_barcode_not_found: { en: "Product with barcode '{barcode}' not found.", mm: "ဘားကုဒ် '{barcode}' နှင့်သက်ဆိုင်သော ပစ္စည်းမရှိပါ။", jp: "バーコード '{barcode}' の製品が見つかりません。" },
            alert_not_enough_stock: { en: "Not enough stock!", mm: "ပစ္စည်းလက်ကျန်မလုံလောက်ပါ!", jp: "在庫が不足しています！" },
            confirm_complete_order_title: { en: "Complete Sale", mm: "အရောင်းပြီးမြောက်ရန်", jp: "販売を完了" },
            confirm_complete_order_msg: { en: "Are you sure you want to complete and process this sale?", mm: "ဤအရောင်းကို ပြီးမြောက်ကြောင်း အတည်ပြုမှာလား?", jp: "この販売を完了して処理してもよろしいですか？" },
            alert_order_complete_fail: { en: "Failed to complete sale.", mm: "အရောင်းပြီးမြောက်ရန်မအောင်မြင်ပါ။", jp: "販売の完了に失敗しました。" },
            confirm_cancel_order_title: { en: "Cancel Sale", mm: "အရောင်းပယ်ဖျက်ရန်", jp: "販売をキャンセル" },
            confirm_cancel_order_msg: { en: "Are you sure you want to cancel this sale?", mm: "ဤအရောင်းကို ပယ်ဖျက်မှာလား?", jp: "この販売をキャンセルしてもよろしいですか？" },
            alert_fill_all_fields: { en: "Please fill all required fields.", mm: "လိုအပ်သောကွက်လပ်အားလုံးကို ဖြည့်စွက်ပေးပါ။", jp: "必須項目をすべて入力してください。" },
            alert_enter_category_name: { en: "Please enter a category name.", mm: "အမျိုးအစားအမည်ကို ထည့်ပေးပါ။", jp: "カテゴリー名を入力してください。" },
            alert_save_category_fail: { en: "Failed to save category.", mm: "အမျိုးအစားသိမ်းဆည်းရန် မအောင်မြင်ပါ။", jp: "カテゴリーの保存に失敗しました。" },
            alert_invalid_tax_rate: { en: "Please enter a valid, non-negative tax rate.", mm: "မှန်ကန်သော အခွန်နှုန်းထည့်ပါ။", jp: "有効な税率を入力してください。" },
            alert_empty_receipt_title: { en: "Receipt title cannot be empty.", mm: "ဘောင်ချာခေါင်းစဉ်အလွတ်မဖြစ်ရပါ။", jp: "レシートのタイトルは空にできません。" },
            alert_settings_saved: { en: "Settings saved successfully!", mm: "ဆက်တင်များအောင်မြင်စွာသိမ်းလိုက်ပါပြီ။", jp: "設定が正常に保存されました！" },
            alert_settings_save_fail: { en: "Failed to save settings.", mm: "ဆက်တင်များသိမ်းရန်မအောင်မြင်ပါ။", jp: "設定の保存に失敗しました。" },
            receipt_share_title: { en: "Your Receipt", mm: "သင်၏ဘောင်ချာ", jp: "あなたのレシート" },
            receipt_share_text: { en: "Here is your receipt from ကောင်းစံ.", mm: "ဤသည်မှာ ကောင်းစံ မှ သင်၏ဘောင်ချာဖြစ်ပါသည်။", jp: "こちらがカウンサンからのレシートです。" },
            alert_sharing_not_supported: { en: "Sharing is not supported on this browser. The receipt image will be downloaded instead.", mm: "ဤဘရောက်ဇာတွင် မျှဝေခြင်းကိုမပံ့ပိုးပါ။ ဘောင်ချာပုံကိုအစားထိုးဒေါင်းလုဒ်လုပ်ပါမည်။", jp: "このブラウザでは共有がサポートされていません。代わりにレシート画像がダウンロードされます。" },
            alert_share_fail: { en: "Could not share or download the receipt.", mm: "ဘောင်ချာကိုမျှဝေရန် (သို့) ဒေါင်းလုဒ်လုပ်ရန်မအောင်မြင်ပါ။", jp: "レシートの共有またはダウンロードができませんでした。" },
            receipt_print_title: { en: "Print Receipt", mm: "ဘောင်ချာပုံနှိပ်ရန်", jp: "レシートを印刷" },
            confirm_delete_item_title: { en: "Confirm Deletion", mm: "ဖျက်ရန်အတည်ပြုပါ", jp: "削除の確認" },
            confirm_delete_item_msg: { en: "Are you sure you want to delete this {type}? This action cannot be undone.", mm: "ဤ {type} ကိုဖျက်မှာသေချာလား? ဤလုပ်ဆောင်ချက်ကိုပြန်ပြင်၍မရပါ။", jp: "この{type}を削除してもよろしいですか？この操作は元に戻せません。" },
            entity_product: { en: "product", mm: "ကုန်ပစ္စည်း", jp: "製品" },
            entity_category: { en: "category", mm: "အမျိုးအစား", jp: "カテゴリー" },
            entity_purchase: { en: "purchase record", mm: "အဝယ်မှတ်တမ်း", jp: "仕入れ記録" },
            alert_cannot_delete_category: { en: "Cannot delete category. It has {count} product(s) assigned to it.", mm: "ဤအမျိုးအစားကိုဖျက်၍မရပါ။ ပစ္စည်း {count} ခုတွင်အသုံးပြုနေပါသည်။", jp: "カテゴリーを削除できません。{count}個の製品が割り当てられています。" },
            alert_delete_fail: { en: "Failed to delete item.", mm: "ဖျက်ရန်မအောင်မြင်ပါ။", jp: "アイテムの削除に失敗しました。" },
            alert_select_date_for_deletion: { en: "Please select a date to delete data for.", mm: "ဒေတာဖျက်ရန်အတွက် ရက်စွဲတစ်ခုရွေးပါ။", jp: "データを削除する日付を選択してください。" },
            confirm_reset_all_data_title: { en: "Reset All Data", mm: "ဒေတာအားလုံးဖျက်မည်", jp: "全データリセット" },
            prompt_reset_all_data_msg: { en: "This will ERASE ALL DATA (products, categories, sales, purchases). This action is permanent. To confirm, type \"DELETE\" in the box below.", mm: "ဤလုပ်ဆောင်ချက်သည် ဒေတာအားလုံးကို (ကုန်ပစ္စည်း၊ အမျိုးအစား၊ အရောင်း၊ အဝယ်) ဖျက်ပစ်ပါမည်။ ဤလုပ်ဆောင်ချက်ကို နောက်ပြန်ပြင်၍မရပါ။ အတည်ပြုရန် \"DELETE\" ဟု အောက်ပါအကွက်တွင် ရိုက်ထည့်ပါ။", jp: "これにより、すべてのデータ（製品、カテゴリ、売上、仕入）が消去されます。この操作は永久的です。確認するには、下のボックスに「DELETE」と入力してください。" },
            prompt_reset_confirm_word: { en: "DELETE", mm: "DELETE", jp: "DELETE" },
            alert_reset_cancelled: { en: "Reset cancelled.", mm: "ဖျက်ခြင်းကိုပယ်ဖျက်လိုက်သည်။", jp: "リセットはキャンセルされました。" },
            alert_all_data_reset: { en: "All data has been reset. Initializing with sample data.", mm: "ဒေတာအားလုံးကို ပြန်ဖျက်ပြီးပါပြီ။ နမူနာဒေတာဖြင့် ပြန်လည်စတင်နေသည်။", jp: "すべてのデータがリセットされました。サンプルデータで初期化しています。" },
            alert_reset_fail: { en: "A critical error occurred during data reset.", mm: "ဒေတာပြန်ဖျက်ရာတွင် ဆိုးရွားသောအမှားတစ်ခုဖြစ်ပွားခဲ့သည်။", jp: "データリセット中に重大なエラーが発生しました。" },
            alert_select_date: { en: "Please select a date", mm: "ရက်စွဲရွေးချယ်ပါ", jp: "日付を選択してください" },
            alert_select_month_year: { en: "Please select a month and year", mm: "လနှင့်နှစ်ကိုရွေးချယ်ပါ", jp: "月と年を選択してください" },
            alert_monthly_report_fail: { en: "Failed to generate monthly report. See console for details.", mm: "လစဉ်အစီရင်ခံစာထုတ်ရန်မအောင်မြင်ပါ။ အသေးစိတ်အတွက် console ကိုစစ်ဆေးပါ။", jp: "月次レポートの生成に失敗しました。詳細はコンソールを確認してください。" },
            filter_all_categories: { en: "All Categories", mm: "အမျိုးအစားအားလုံး", jp: "すべてのカテゴリー" },
            filter_all: { en: "All", mm: "အားလုံး", jp: "すべて" },
            filter_by_date: { en: "By Date", mm: "ရက်စွဲအလိုက်", jp: "日付別" },
            filter_by_month: { en: "By Month", mm: "လအလိုက်", jp: "月別" },
            filter_low_stock_only: { en: "Show Low Stock Only", mm: "ကုန်နီးသောပစ္စည်းသာပြရန်", jp: "在庫僅少のみ表示" },
            label_filter_by: { en: "Filter by:", mm: "စစ်ထုတ်ရန်:", jp: "フィルター:" },
            label_date: { en: "Date:", mm: "ရက်စွဲ:", jp: "日付:" },
            label_month: { en: "Month:", mm: "လ:", jp: "月:" },
            label_year: { en: "Year:", mm: "နှစ်:", jp: "年:" },
            btn_apply_filter: { en: "Apply Filter", mm: "စစ်ထုတ်မည်", jp: "フィルター適用" },
            btn_clear_filter: { en: "Clear Filter", mm: "ပြန်စမည်", jp: "フィルター解除" },
            label_uncategorized: { en: "Uncategorized", mm: "အမျိုးအစားမခွဲထား", jp: "未分類" },
            label_out_of_stock: { en: "Out of Stock", mm: "ကုန်ပစ္စည်းမရှိ", jp: "在庫切れ" },
            label_low_stock: { en: "Low Stock", mm: "ကုန်တော့မည်", jp: "在庫僅少" },
            label_in_stock: { en: "In Stock", mm: "ပစ္စည်းရှိ", jp: "在庫あり" },
            receipt_sale_id: { en: "Sale ID", mm: "အရောင်းနံပါတ်", jp: "販売ID" },
            receipt_date: { en: "Date", mm: "ရက်စွဲ", jp: "日付" },
            receipt_thank_you: { en: "Thank you for your purchase!", mm: "ဝယ်ယူအားပေးမှုအတွက် ကျေးဇူးတင်ပါသည်။", jp: "ご購入ありがとうございました！" },
            table_item: { en: "Item", mm: "ပစ္စည်း", jp: "品目" },
            table_qty: { en: "Qty", mm: "အရေအတွက်", jp: "数量" },
            table_total: { en: "Total", mm: "စုစုပေါင်း", jp: "合計" },
            label_total: { en: "Total", mm: "စုစုပေါင်း", jp: "合計" },
            stat_total_revenue: { en: "Total Revenue", mm: "စုစုပေါင်းဝင်ငွေ", jp: "総収益" },
            stat_total_cost: { en: "Total Cost", mm: "စုစုပေါင်းကုန်ကျငွေ", jp: "総費用" },
            stat_net_profit: { en: "Net Profit", mm: "အသားတင်အမြတ်", jp: "純利益" },
            title_completed_sales: { en: "Completed Sales ({count})", mm: "ပြီးမြောက်သောအရောင်းများ ({count})", jp: "完了した販売 ({count})" },
            title_purchases_made: { en: "Purchases Made ({count})", mm: "ပြုလုပ်ခဲ့သော အဝယ်များ ({count})", jp: "行われた仕入れ ({count})" },
            title_top_selling_products: { en: "Top 7 Selling Products", mm: "အရောင်းရဆုံး ပစ္စည်း (၇) မျိုး", jp: "トップ7販売製品" },
            table_quantity_sold: { en: "Quantity Sold", mm: "ရောင်းရအရေအတွက်", jp: "販売数量" },
            table_revenue: { en: "Revenue", mm: "ရောင်းရငွေ", jp: "収益" },
            month_names: {
                en: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                mm: ["ဇန်နဝါရီ", "ဖေဖော်ဝါရီ", "မတ်", "ဧပြီ", "မေ", "ဇွန်", "ဇူလိုင်", "ဩဂုတ်", "စက်တင်ဘာ", "အောက်တိုဘာ", "နိုဝင်ဘာ", "ဒီဇင်ဘာ"],
                jp: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"]
            }
        };

        function getTranslation(key, replacements = {}) {
            const lang = state.currentLanguage;
            let text = translations[key]?.[lang] || translations[key]?.['en'] || key;
            
            if (typeof text === 'string') {
                for (const placeholder in replacements) {
                    text = text.replace(new RegExp(`\\{${placeholder}\\}`, 'g'), replacements[placeholder]);
                }
            }
            return text;
        }

        function translateUI(lang) {
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                const translationType = el.dataset.translateType;
                const text = getTranslation(key);
                
                if (translationType === 'list') {
                     el.innerHTML = text;
                } else {
                     el.textContent = text;
                }
            });

            document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                const key = el.dataset.translatePlaceholder;
                el.placeholder = getTranslation(key);
            });
        }

        async function setLanguage(lang) {
            state.currentLanguage = lang;
            UIElements.languageSelect.value = lang;
            await db.put('settings', { key: 'language', value: lang });
            await populateFilterDropdowns();
            populateDynamicFilters();
            await renderReportsPage();
            await renderSettingsPage();
            translateUI(lang);
        }

        function setupEventListeners() {
            UIElements.sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    state.currentSection = e.currentTarget.dataset.section;
                    render();
                    if (window.innerWidth < 992) UIElements.sidebar.classList.remove('akmshow');
                });
            });
            UIElements.bottomNav.addEventListener('click', (e) => {
                e.preventDefault();
                const link = e.target.closest('.akmbottom-nav-link');
                if (link) {
                    state.currentSection = link.dataset.section;
                    render();
                }
            });
            UIElements.menuToggle.addEventListener('click', () => UIElements.sidebar.classList.toggle('akmshow'));
            UIElements.themeToggle.addEventListener('click', toggleTheme);
            document.getElementById('new-order-btn').addEventListener('click', handleNewSaleFromDashboard);
            document.getElementById('add-new-product-btn').addEventListener('click', () => openProductModal());
            document.getElementById('add-new-category-btn').addEventListener('click', () => openCategoryModal());
            document.getElementById('add-new-purchase-btn').addEventListener('click', () => openPurchaseModal());
            UIElements.productsSearchInput.addEventListener('input', renderProductsPage);
            UIElements.productCategoryFilter.addEventListener('change', renderProductsPage);
            UIElements.stockSearchInput.addEventListener('input', renderStockPage);
            UIElements.stockCategoryFilter.addEventListener('change', renderStockPage);
            UIElements.lowStockFilterCheckbox.addEventListener('change', renderStockPage);
            UIElements.stockTableBody.addEventListener('change', handleStockThresholdChange);
            UIElements.expiringSoonSearchInput.addEventListener('input', renderExpiringSoonPage);
            UIElements.expiringSoonCategoryFilter.addEventListener('change', renderExpiringSoonPage);
            UIElements.expiringDaysFilter.addEventListener('change', renderExpiringSoonPage);
            UIElements.categoryTabs.addEventListener('click', e => { 
                if (e.target.matches('.akmcategory-tab')) renderProductsGrid(e.target.dataset.id); 
            });
            document.getElementById('product-search').addEventListener('input', () => {
                const activeTab = document.querySelector('.akmcategory-tab.akmactive');
                if(activeTab) renderProductsGrid(activeTab.dataset.id);
            });
            UIElements.productsGrid.addEventListener('click', e => { const card = e.target.closest('.akmproduct-card:not(.akmdisabled)'); if (card) addProductToOrder(card.dataset.id); });
            UIElements.orderItemsList.addEventListener('click', handleOrderItemQuantityChange);
            UIElements.orderDiscount.addEventListener('input', renderCurrentOrder); 
            UIElements.paymentMethodGroup.addEventListener('click', handlePaymentMethodSelect);
            UIElements.completeOrderBtn.addEventListener('click', handleCompleteOrder);
            UIElements.cancelOrderBtn.addEventListener('click', handleCancelOrder);
            UIElements.launchScannerBtn.addEventListener('click', () => launchGenericScanner(handleScannedBarcodeForOrder));
            document.getElementById('scan-product-barcode-btn').addEventListener('click', () => {
                launchGenericScanner((barcode) => {
                    document.getElementById('product-barcode').value = barcode;
                });
            });
            document.getElementById('scan-purchase-item-btn').addEventListener('click', () => launchGenericScanner(handleScannedBarcodeForPurchase));
            UIElements.purchaseCategorySelect.addEventListener('change', handlePurchaseCategoryChange);
            setupPurchaseCostCalculators();
            UIElements.purchaseFilterType.addEventListener('change', () => {
                const type = document.querySelector('input[name="purchase-filter-type"]:checked').value;
                UIElements.purchaseDateFilterGroup.style.display = type === 'date' ? 'flex' : 'none';
                UIElements.purchaseMonthFilterGroup.style.display = type === 'month' ? 'flex' : 'none';
            });
            document.getElementById('apply-purchase-filter-btn').addEventListener('click', renderPurchasesPage);
            document.getElementById('clear-purchase-filter-btn').addEventListener('click', () => {
                document.getElementById('filter-all-purchases').checked = true;
                UIElements.purchaseDateFilterGroup.style.display = 'none';
                UIElements.purchaseMonthFilterGroup.style.display = 'none';
                renderPurchasesPage();
            });
            document.getElementById('export-purchases-pdf-btn').addEventListener('click', handleExportPurchasesPDF);
            document.getElementById('export-purchases-csv-btn').addEventListener('click', handleExportPurchasesCSV);
            UIElements.languageSelect.addEventListener('change', (e) => setLanguage(e.target.value));
            UIElements.appModeSelect.addEventListener('change', handleAppModeChange);
            UIElements.barcodeScannerModeSelect.addEventListener('change', handleBarcodeModeChange);
            document.getElementById('connect-printer-btn').addEventListener('click', connectToBluetoothPrinter);
            UIElements.deleteDataByDateBtn.addEventListener('click', handleDeleteDataByDate);
            UIElements.deleteDataByMonthBtn.addEventListener('click', handleDeleteDataByMonth);
            UIElements.resetDataBtn.addEventListener('click', handleResetAllData);
            document.getElementById('save-product-btn').addEventListener('click', handleSaveProduct);
            document.getElementById('save-category-btn').addEventListener('click', handleSaveCategory);
            document.getElementById('save-purchase-btn').addEventListener('click', handleSavePurchase);
            document.getElementById('save-settings-btn').addEventListener('click', handleSaveSettings);
            document.getElementById('generate-report-btn').addEventListener('click', generateDailyReport);
            document.getElementById('generate-monthly-report-btn').addEventListener('click', generateMonthlyReport);
            document.getElementById('export-pdf-btn').addEventListener('click', () => exportToPDF('#report-content', `report-${state.reportData.dateTitle}.pdf`));
            document.getElementById('export-csv-btn').addEventListener('click', handleExportReportCSV);
            document.querySelectorAll('.akmmodal-close').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.akmmodal').id)));
            document.body.addEventListener('click', handleBodyClick);
            UIElements.reportModal.addEventListener('click', (e) => {
                const button = e.target.closest('button[data-action="view-sale-details"]');
                if (button) showSaleDetailsModal(button.dataset.id);
            });
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => closeModal('confirm-modal'));
            document.getElementById('delete-product-btn').addEventListener('click', () => {
                const id = document.getElementById('product-id').value;
                if(id) openDeleteModal(id, 'product', true);
            });
            document.getElementById('delete-category-btn').addEventListener('click', () => {
                const id = document.getElementById('category-id').value;
                if(id) openDeleteModal(id, 'category', true);
            });
            document.getElementById('share-receipt-btn').addEventListener('click', handleShareReceipt);
            document.getElementById('print-receipt-btn').addEventListener('click', handleSaveReceiptAsImage);
            document.getElementById('bluetooth-print-btn').addEventListener('click', () => printViaBluetooth(lastCompletedOrder));
            setupImageUploadListeners();
        }
        
        function handleBodyClick(e) {
            const button = e.target.closest('button');
            const image = e.target.closest('.akmproduct-table-image');
            if (button) {
                const { action, id } = button.dataset;
                if (!action || !id) return;
                switch(action) {
                    case 'edit-product': openProductModal(id); break;
                    case 'delete-product': openDeleteModal(id, 'product'); break;
                    case 'edit-category': openCategoryModal(id); break;
                    case 'delete-category': openDeleteModal(id, 'category'); break;
                    case 'delete-purchase': openDeleteModal(id, 'purchase'); break;
                    case 'delete-sale': openDeleteModal(id, 'sale'); break;
                }
            }
            if (image) viewFullImage(image.src);
        }

        async function handleStockThresholdChange(e) {
            if (e.target.classList.contains('akmstock-threshold-input')) {
                const productId = e.target.dataset.productId;
                const newThreshold = parseInt(e.target.value, 10);
                if (productId && !isNaN(newThreshold) && newThreshold >= 0) {
                    try {
                        const stockItem = await db.get('stock', productId);
                        stockItem.lowThreshold = newThreshold;
                        await db.put('stock', stockItem);
                        e.target.style.borderColor = 'var(--success-color)';
                        setTimeout(() => { e.target.style.borderColor = '' }, 2000);
                        await renderStockPage();
                    } catch (error) {
                        console.error('Failed to update threshold:', error);
                        e.target.style.borderColor = 'var(--danger-color)';
                    }
                }
            }
        }

        function handleOrderItemQuantityChange(e) {
            const button = e.target.closest('button');
            if(!button) return;
            const action = button.dataset.action;
            const productId = button.dataset.id;
            if (action === 'increase-qty') updateOrderItemQuantity(productId, 1);
            else if (action === 'decrease-qty') updateOrderItemQuantity(productId, -1);
        }
        
        function handlePaymentMethodSelect(e) {
            const selectedBtn = e.target.closest('.akmpayment-btn');
            if (!selectedBtn) return;
            
            document.querySelectorAll('.akmpayment-btn').forEach(btn => btn.classList.remove('akmactive'));
            selectedBtn.classList.add('akmactive');
        }

        async function handleAppModeChange(e) {
            const newMode = e.target.value;
            await db.put('settings', { key: 'appMode', value: newMode });
            applyAppMode(newMode);
        }
        
        async function handleBarcodeModeChange(e) {
            const newMode = e.target.value;
            await db.put('settings', { key: 'barcodeScannerMode', value: newMode });
            applyBarcodeScannerMode(newMode);
        }
        
        function setupImageUploadListeners() {
            const imageUpload = document.getElementById('product-image-upload');
            const imagePreview = document.getElementById('product-image-preview');
            const removeImageBtn = document.getElementById('remove-image-btn');
            imageUpload.addEventListener('change', () => {
                const file = imageUpload.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                        removeImageBtn.style.display = 'inline-flex';
                    };
                    reader.readAsDataURL(file);
                }
            });
            removeImageBtn.addEventListener('click', () => {
                imagePreview.src = '';
                imagePreview.style.display = 'none';
                removeImageBtn.style.display = 'none';
                imageUpload.value = '';
            });
        }
        
        async function handleNewSaleFromDashboard() {
            state.currentSection = 'orders';
            await render();
            handleNewOrder();
            
            if (state.barcodeScannerMode === 'on') {
                launchGenericScanner(handleScannedBarcodeForOrder);
            }
        }

        function handleNewOrder() {
            if (state.currentOrder && state.currentOrder.items.length > 0) {
                showConfirmation({
                    title: getTranslation('confirm_cancel_order_title'),
                    message: getTranslation('confirm_cancel_active_order'),
                    onConfirm: () => {
                        createNewOrderObject();
                        renderCurrentOrder();
                    }
                });
            } else {
                 createNewOrderObject();
                 renderCurrentOrder();
            }
        }
        
        function createNewOrderObject() {
            state.currentOrder = {
                id: `ord-${Date.now()}`,
                date: new Date().toISOString().slice(0, 10),
                dateTime: new Date().toISOString(),
                status: 'active',
                items: [],
                subtotal: 0, 
                discount: 0,
                tax: 0, 
                total: 0,
                paymentMethod: 'cash',
            };
            UIElements.orderDiscount.value = '';
        }
        
        async function addProductToOrder(productId) {
            if (!state.currentOrder) createNewOrderObject();
            
            const [product, stock] = await Promise.all([db.get('products', productId), db.get('stock', productId)]);
            const existingItem = state.currentOrder.items.find(item => item.productId === productId);

            if (stock.quantity <= (existingItem ? existingItem.quantity : 0)) {
                alert(getTranslation('alert_out_of_stock', { productName: product.name }));
                return;
            }

            if (existingItem) existingItem.quantity++;
            else state.currentOrder.items.push({ productId: product.id, name: product.name, price: product.price, quantity: 1 });
            
            renderCurrentOrder();
        }
        
        async function updateOrderItemQuantity(productId, change) {
            const item = state.currentOrder.items.find(i => i.productId === productId);
            if (!item) return;

            if (change > 0) {
                const stock = await db.get('stock', productId);
                if (item.quantity + change > stock.quantity) {
                    alert(getTranslation('alert_not_enough_stock'));
                    return;
                }
            }
            item.quantity += change;
            if (item.quantity <= 0) state.currentOrder.items = state.currentOrder.items.filter(i => i.productId !== productId);
            
            renderCurrentOrder();
        }
        
        function handleCompleteOrder() {
            if (!state.currentOrder || state.currentOrder.items.length === 0) return;
            
            showConfirmation({
                title: getTranslation('confirm_complete_order_title'),
                message: getTranslation('confirm_complete_order_msg'),
                isDanger: false,
                okText: 'btn_complete',
                async onConfirm() {
                    try {
                        for (const item of state.currentOrder.items) {
                            const stockItem = await db.get('stock', item.productId);
                            if (stockItem) {
                                stockItem.quantity -= item.quantity;
                                await db.put('stock', stockItem);
                            }
                        }
                        state.currentOrder.status = 'completed';
                        const paymentBtn = UIElements.paymentMethodGroup.querySelector('.akmpayment-btn.akmactive');
                        state.currentOrder.paymentMethod = paymentBtn ? paymentBtn.dataset.payment : 'cash';

                        const completedOrder = { ...state.currentOrder };
                        await db.add('orders', completedOrder);
                        
                        lastCompletedOrder = completedOrder;
                        state.currentOrder = null;
                        
                        closeModal('confirm-modal');
                        await renderOrdersPage();
                        await renderDashboard();
                        await showReceiptModal(completedOrder);
                    } catch (error) {
                        console.error('Error completing order:', error);
                        alert(getTranslation('alert_order_complete_fail'));
                        closeModal('confirm-modal');
                    }
                }
            });
        }

        function handleCancelOrder() {
            if (!state.currentOrder) return;
            showConfirmation({
                title: getTranslation('confirm_cancel_order_title'),
                message: getTranslation('confirm_cancel_order_msg'),
                onConfirm: () => {
                    state.currentOrder = null;
                    renderOrdersPage();
                    closeModal('confirm-modal');
                }
            });
        }

        async function openProductModal(productId = null) {
            document.getElementById('product-form').reset();
            document.getElementById('product-image-preview').style.display = 'none';
            document.getElementById('remove-image-btn').style.display = 'none';

            const catSelect = document.getElementById('product-category');
            catSelect.innerHTML = `<option value="">${getTranslation('placeholder_select_category')}</option>` + 
                (await db.getAll('categories')).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            const title = document.getElementById('product-modal-title');
            const delBtn = document.getElementById('delete-product-btn');
            const idInput = document.getElementById('product-id');
            const barcodeInput = document.getElementById('product-barcode');
            const barcodeLabel = document.querySelector('label[for="product-barcode"]');

            if (state.barcodeScannerMode === 'on') {
                barcodeInput.required = true;
                barcodeLabel.innerHTML = getTranslation('label_product_barcode') + ' <span style="color:var(--danger-color)">*</span>';
            } else {
                barcodeInput.required = false;
                barcodeLabel.textContent = getTranslation('label_product_barcode');
            }

            if (productId) {
                const product = await db.get('products', productId);
                title.textContent = getTranslation('modal_edit_product_title');
                delBtn.style.display = 'inline-flex';
                idInput.value = product.id;
                document.getElementById('product-name').value = product.name;
                barcodeInput.value = product.barcode || '';
                document.getElementById('product-price').value = product.price;
                catSelect.value = product.categoryId;
                if (product.image) {
                    document.getElementById('product-image-preview').src = product.image;
                    document.getElementById('product-image-preview').style.display = 'block';
                    document.getElementById('remove-image-btn').style.display = 'inline-flex';
                }
            } else {
                title.textContent = getTranslation('modal_add_product_title');
                delBtn.style.display = 'none';
                idInput.value = '';
                barcodeInput.value = '';
            }
            openModal('product-modal');
        }

        async function handleSaveProduct() {
            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value.trim();
            const barcode = document.getElementById('product-barcode').value.trim();
            const price = parseFloat(document.getElementById('product-price').value);
            const categoryId = document.getElementById('product-category').value;
            const imageSrc = document.getElementById('product-image-preview').src;
            const image = imageSrc.startsWith('data:image') ? imageSrc : null;

            if (state.barcodeScannerMode === 'on' && !barcode) {
                alert(getTranslation('alert_barcode_required'));
                return;
            }
            if (!name || isNaN(price) || !categoryId) { 
                alert(getTranslation('alert_fill_all_fields')); 
                return; 
            }
            
            try {
                if (id) {
                    const product = await db.get('products', id);
                    await db.put('products', { ...product, name, barcode, price, categoryId, image });
                } else {
                    const newId = `prod-${Date.now()}`;
                    await db.add('products', { id: newId, name, barcode, price, categoryId, image });
                    await db.add('stock', { productId: newId, quantity: 0, lowThreshold: 10 });
                }
                await renderProductsPage();
                await renderStockPage();
                closeModal('product-modal');
            } catch (error) {
                if (error.name === 'ConstraintError') {
                    alert(`Barcode "${barcode}" is already in use.`);
                } else {
                    console.error('Error saving product:', error);
                }
            }
        }
        
        async function openCategoryModal(categoryId = null) {
            document.getElementById('category-form').reset();
            const title = document.getElementById('category-modal-title');
            const delBtn = document.getElementById('delete-category-btn');
            const idInput = document.getElementById('category-id');

            if (categoryId) {
                const category = await db.get('categories', categoryId);
                title.textContent = getTranslation('modal_edit_category_title');
                delBtn.style.display = 'inline-flex';
                idInput.value = category.id;
                document.getElementById('category-name').value = category.name;
            } else {
                title.textContent = getTranslation('modal_add_category_title');
                delBtn.style.display = 'none';
                idInput.value = '';
            }
            openModal('category-modal');
        }

        async function handleSaveCategory() {
            const id = document.getElementById('category-id').value;
            const name = document.getElementById('category-name').value.trim();
            if (!name) { alert(getTranslation('alert_enter_category_name')); return; }

            try {
                if (id) {
                    await db.put('categories', { id, name });
                } else {
                    await db.add('categories', { id: `cat-${Date.now()}`, name });
                }
                await renderCategoriesPage();
                await populateFilterDropdowns();
                closeModal('category-modal');
            } catch (error) {
                console.error('Error saving category:', error);
                alert(getTranslation('alert_save_category_fail'));
            }
        }

        async function openPurchaseModal() {
            document.getElementById('purchase-form').reset();
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('purchase-date').value = now.toISOString().slice(0, 16);
            
            const categories = await db.getAll('categories');
            UIElements.purchaseCategorySelect.innerHTML = `<option value="">${getTranslation('placeholder_select_category_first')}</option>` + 
                categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            UIElements.purchaseProductSelect.innerHTML = `<option value="">${getTranslation('placeholder_select_product')}</option>`;
            UIElements.purchaseProductSelect.disabled = true;

            openModal('purchase-modal');
        }

        async function handlePurchaseCategoryChange() {
            const categoryId = UIElements.purchaseCategorySelect.value;
            if (!categoryId) {
                UIElements.purchaseProductSelect.innerHTML = `<option value="">${getTranslation('placeholder_select_product')}</option>`;
                UIElements.purchaseProductSelect.disabled = true;
                return;
            }

            const allProducts = await db.getAll('products');
            const filteredProducts = allProducts.filter(p => p.categoryId === categoryId);
            
            if(filteredProducts.length > 0) {
                UIElements.purchaseProductSelect.innerHTML = `<option value="" disabled selected>${getTranslation('placeholder_select_product')}</option>` + filteredProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                UIElements.purchaseProductSelect.disabled = false;
            } else {
                UIElements.purchaseProductSelect.innerHTML = `<option value="">${getTranslation('empty_no_products_in_category')}</option>`;
                UIElements.purchaseProductSelect.disabled = true;
            }
        }

        function setupPurchaseCostCalculators() {
            const quantityInput = document.getElementById('purchase-quantity');
            const unitCostInput = document.getElementById('purchase-unit-cost');
            const totalCostInput = document.getElementById('purchase-total-cost');
        
            const calculateTotal = () => {
                const quantity = parseFloat(quantityInput.value) || 0;
                const unitCost = parseFloat(unitCostInput.value) || 0;
                if (quantity > 0 && unitCost > 0) {
                    totalCostInput.value = (quantity * unitCost).toFixed(2);
                }
            };
        
            const calculateUnit = () => {
                const quantity = parseFloat(quantityInput.value) || 0;
                const totalCost = parseFloat(totalCostInput.value) || 0;
                if (quantity > 0 && totalCost > 0) {
                    unitCostInput.value = (totalCost / quantity).toFixed(2);
                }
            };
        
            quantityInput.addEventListener('input', calculateTotal);
            unitCostInput.addEventListener('input', calculateTotal);
            totalCostInput.addEventListener('input', calculateUnit);
        }
        
        async function handleSavePurchase() {
            const productId = document.getElementById('purchase-product').value;
            const quantity = parseInt(document.getElementById('purchase-quantity').value);
            const unitCost = parseFloat(document.getElementById('purchase-unit-cost').value);
            const totalCost = parseFloat(document.getElementById('purchase-total-cost').value);
            const supplier = document.getElementById('purchase-supplier').value.trim();
            const dateTime = document.getElementById('purchase-date').value;
            const expiryDate = document.getElementById('purchase-expiry-date').value;

            if (!productId || !quantity || (!unitCost && !totalCost) || !dateTime) { 
                alert(getTranslation('alert_fill_all_fields')); 
                return; 
            }
            if (state.appMode === 'bakery' && !expiryDate) {
                alert(getTranslation('alert_fill_all_fields'));
                return;
            }

            try {
                const finalUnitCost = unitCost || totalCost / quantity;
                const finalTotalCost = totalCost || unitCost * quantity;

                const product = await db.get('products', productId);
                const purchase = {
                    id: `pch-${Date.now()}`,
                    productId,
                    productName: product.name,
                    supplier,
                    quantity,
                    unitCost: finalUnitCost,
                    totalCost: finalTotalCost,
                    dateTime,
                    ...(state.appMode === 'bakery' && { expiryDate: expiryDate })
                };
                await db.add('purchases', purchase);

                const stockItem = await db.get('stock', productId);
                stockItem.quantity += quantity;
                await db.put('stock', stockItem);
                
                await Promise.all([renderPurchasesPage(), renderStockPage(), renderDashboard()]);
                if (state.appMode === 'bakery') await renderExpiringSoonPage();
                closeModal('purchase-modal');
            } catch (error) {
                console.error('Error saving purchase:', error);
            }
        }
        
        async function handleSaveSettings() {
            const newTaxRate = parseFloat(UIElements.taxRateSetting.value);
            const newReceiptTitle = UIElements.receiptTitleSetting.value.trim();
        
            if (isNaN(newTaxRate) || newTaxRate < 0) {
                alert(getTranslation('alert_invalid_tax_rate'));
                return;
            }
        
            if (!newReceiptTitle) {
                alert(getTranslation('alert_empty_receipt_title'));
                return;
            }
        
            try {
                await Promise.all([
                    db.put('settings', {key: 'taxRate', value: newTaxRate}),
                    db.put('settings', {key: 'receiptTitle', value: newReceiptTitle})
                ]);
                
                state.taxRate = newTaxRate;
                alert(getTranslation('alert_settings_saved'));
            } catch (error) {
                console.error("Error saving settings:", error);
                alert(getTranslation('alert_settings_save_fail'));
            }
        }
        
        async function showReceiptModal(order) {
            const receiptTitleSetting = await db.get('settings', 'receiptTitle');
            const receiptTitle = receiptTitleSetting?.value || 'ကောင်းစံ Retail';
        
            const receiptContent = document.getElementById('receipt-content');
            receiptContent.innerHTML = `
                <h4>${receiptTitle}</h4>
                <p>${getTranslation('receipt_sale_id')}: ${order.id.slice(-8)}</p>
                <p>${getTranslation('receipt_date')}: ${new Date(order.dateTime).toLocaleString()}</p>
                <p>${getTranslation('payment_method')}: <span style="text-transform: capitalize;">${getTranslation('payment_' + order.paymentMethod)}</span></p>
                <div class="akmreceipt-divider"></div>
                <table>
                    <thead>
                        <tr><th>${getTranslation('table_item')}</th><th>${getTranslation('table_qty')}</th><th class="akmtext-right">${getTranslation('table_total')}</th></tr>
                    </thead>
                    <tbody>
                        ${order.items.map(i => `<tr><td>${i.name}</td><td>${i.quantity}</td><td class="akmtext-right">${formatCurrency(i.quantity * i.price)}</td></tr>`).join('')}
                    </tbody>
                </table>
                <div class="akmreceipt-divider"></div>
                <div class="akmtotal-section">
                    <p style="display:flex; justify-content:space-between;"><span>${getTranslation('label_subtotal')}:</span> <span>${formatCurrency(order.subtotal)}</span></p>
                    <p style="display:flex; justify-content:space-between;"><span>${getTranslation('label_discount')}:</span> <span>-${formatCurrency(order.discount)}</span></p>
                    <p style="display:flex; justify-content:space-between;"><span>${getTranslation('label_tax_rate_value', { rate: state.taxRate })}:</span> <span>${formatCurrency(order.tax)}</span></p>
                    <div class="akmreceipt-divider"></div>
                    <h4 style="display:flex; justify-content:space-between;"><span>${getTranslation('label_total')}:</span> <span>${formatCurrency(order.total)}</span></h4>
                </div>
                <p class="akmfooter-text">${getTranslation('receipt_thank_you')}</p>
            `;
            openModal('receipt-modal');
        }
        
        async function handleShareReceipt() {
            const receiptElement = document.getElementById('receipt-content');
            const shareBtn = document.getElementById('share-receipt-btn');
            shareBtn.disabled = true;
            shareBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${getTranslation('btn_sharing')}`;

            try {
                const canvas = await html2canvas(receiptElement, {
                    backgroundColor: document.body.classList.contains('akmdark-mode') ? '#242526' : '#FFFFFF'
                });
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const file = new File([blob], `receipt-${Date.now()}.png`, { type: 'image/png' });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: getTranslation('receipt_share_title'),
                        text: getTranslation('receipt_share_text')
                    });
                } else {
                   handleSaveReceiptAsImage();
                }
            } catch (err) {
                console.error('Sharing failed:', err);
                alert(getTranslation('alert_share_fail'));
            } finally {
                shareBtn.disabled = false;
                shareBtn.innerHTML = `<i class="fas fa-share-alt"></i> ${getTranslation('btn_share_receipt')}`;
            }
        }
        
        async function handleSaveReceiptAsImage() {
            const receiptElement = document.getElementById('receipt-content');
            try {
                const canvas = await html2canvas(receiptElement, {
                    backgroundColor: document.body.classList.contains('akmdark-mode') ? '#242526' : '#FFFFFF'
                });
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = `receipt-${Date.now()}.png`;
                link.click();
            } catch (err) {
                console.error('Saving receipt failed:', err);
                alert(getTranslation('alert_share_fail'));
            }
        }

        
        function viewFullImage(src) {
            if (!src) return;
            document.getElementById('full-size-image').src = src;
            openModal('image-viewer-modal');
        }

        async function showSaleDetailsModal(saleId) {
            try {
                const sale = await db.get('orders', saleId);
                if (!sale) return;

                const modal = document.getElementById('sale-details-modal');
                modal.querySelector('.akmmodal-title').textContent = `${getTranslation('modal_sale_details_title')} #${sale.id.slice(-8)}`;
                
                let itemsHtml = sale.items.map(item => `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(item.price)}</td>
                        <td class="akmtext-right">${formatCurrency(item.price * item.quantity)}</td>
                    </tr>
                `).join('');
                
                modal.querySelector('.akmmodal-body').innerHTML = `
                    <p><strong>${getTranslation('receipt_date')}:</strong> ${new Date(sale.dateTime).toLocaleString()}</p>
                    <p><strong>${getTranslation('payment_method')}:</strong> <span style="text-transform: capitalize;">${getTranslation('payment_' + sale.paymentMethod)}</span></p>
                    <div class="akmtable-responsive">
                        <table class="akmtable">
                            <thead><tr><th>${getTranslation('table_item')}</th><th>${getTranslation('table_qty')}</th><th>${getTranslation('table_price')}</th><th class="akmtext-right">${getTranslation('table_total')}</th></tr></thead>
                            <tbody>${itemsHtml}</tbody>
                        </table>
                    </div>
                    <div class="akmorder-summary" style="margin-top: 15px; border-top: 1px solid var(--glass-border); padding-top: 10px;">
                        <div class="akmsummary-row"><span class="akmsummary-label">${getTranslation('label_subtotal')}:</span><span class="akmsummary-value">${formatCurrency(sale.subtotal)}</span></div>
                        <div class="akmsummary-row"><span class="akmsummary-label">${getTranslation('label_discount')}:</span><span class="akmsummary-value">-${formatCurrency(sale.discount)}</span></div>
                        <div class="akmsummary-row"><span class="akmsummary-label">${getTranslation('label_tax_rate_value', { rate: state.taxRate })}:</span><span class="akmsummary-value">${formatCurrency(sale.tax)}</span></div>
                        <div class="akmsummary-row akmgrand-total"><span class="akmsummary-label">${getTranslation('label_grand_total')}:</span><span class="akmsummary-value">${formatCurrency(sale.total)}</span></div>
                    </div>
                `;
                openModal('sale-details-modal');
            } catch (error) {
                console.error("Error showing sale details:", error);
            }
        }

        function openDeleteModal(id, type, fromModal = false) {
            itemToDelete = { id, type, fromModal };
            const typeName = getTranslation(`entity_${type}`);
            
            showConfirmation({
                title: getTranslation('confirm_delete_item_title'),
                message: getTranslation('confirm_delete_item_msg', { type: typeName }),
                okText: 'btn_delete',
                onConfirm: handleDelete
            });
        }

        async function handleDelete() {
            if (!itemToDelete) return;
            const { id, type, fromModal } = itemToDelete;
            try {
                if (type === 'product') {
                    await db.delete('products', id);
                    await db.delete('stock', id);
                    const purchases = await db.getAll('purchases', 'productId', id);
                    for(const p of purchases) await db.delete('purchases', p.id);
                    await Promise.all([renderProductsPage(), renderStockPage(), renderPurchasesPage()]);
                } else if (type === 'category') {
                    const productCount = await db.count('products', 'categoryId', id);
                    if (productCount > 0) {
                        alert(getTranslation('alert_cannot_delete_category', { count: productCount }));
                        closeModal('confirm-modal');
                        return;
                    }
                    await db.delete('categories', id);
                    await renderCategoriesPage();
                    await populateFilterDropdowns();
                } else if (type === 'purchase') {
                    const purchase = await db.get('purchases', id);
                    const stockItem = await db.get('stock', purchase.productId);
                    if (stockItem) {
                        stockItem.quantity = Math.max(0, stockItem.quantity - purchase.quantity);
                        await db.put('stock', stockItem);
                    }
                    await db.delete('purchases', id);
                    await Promise.all([renderPurchasesPage(), renderStockPage(), renderDashboard()]);
                }
                
                closeModal('confirm-modal');
                if (fromModal) closeModal(`${type}-modal`);

            } catch (error) {
                console.error("Deletion failed:", error);
                alert(getTranslation('alert_delete_fail'));
            } finally {
                itemToDelete = null;
            }
        }

        async function deleteTransactionsAndReconcileStock(startDate, endDate) {
            const orderRange = IDBKeyRange.bound(startDate, endDate);
            const purchaseRange = IDBKeyRange.bound(`${startDate}T00:00`, `${endDate}T23:59:59`);
        
            const [ordersToDelete, purchasesToDelete] = await Promise.all([
                db.getAll('orders', 'date', orderRange).then(orders => orders.filter(o => o.status === 'completed')),
                db.getAll('purchases', 'dateTime', purchaseRange)
            ]);
        
            if (ordersToDelete.length === 0 && purchasesToDelete.length === 0) return;
        
            const stockAdjustments = new Map();
        
            ordersToDelete.forEach(order => {
                order.items.forEach(item => {
                    const currentAdj = stockAdjustments.get(item.productId) || 0;
                    stockAdjustments.set(item.productId, currentAdj + item.quantity);
                });
            });
        
            purchasesToDelete.forEach(purchase => {
                const currentAdj = stockAdjustments.get(purchase.productId) || 0;
                stockAdjustments.set(purchase.productId, currentAdj - purchase.quantity);
            });
        
            const tx = dbInstance.transaction(['stock', 'orders', 'purchases'], 'readwrite');
            const stockStore = tx.objectStore('stock');
            const orderStore = tx.objectStore('orders');
            const purchaseStore = tx.objectStore('purchases');
                
            for (const [productId, adjustment] of stockAdjustments.entries()) {
                const stockItem = await stockStore.get(productId);
                if (stockItem) {
                    stockItem.quantity += adjustment;
                    stockStore.put(stockItem);
                }
            }

            ordersToDelete.forEach(o => orderStore.delete(o.id));
            purchasesToDelete.forEach(p => purchaseStore.delete(p.id));

            return new Promise((resolve, reject) => {
                tx.oncomplete = resolve;
                tx.onerror = event => reject(event.target.error);
            });
        }

        async function handleDeleteDataByDate() {
            const date = document.getElementById('delete-data-date').value;
             if (!date) {
                alert(getTranslation('alert_select_date'));
                return;
            }

            showConfirmation({
                title: getTranslation('label_delete_by_date'),
                message: getTranslation('confirm_delete_data_for_date_msg', { date }),
                async onConfirm() {
                    try {
                        await deleteTransactionsAndReconcileStock(date, date);
                        alert(getTranslation('alert_data_deleted_for_date', { date }));
                        await renderDashboard();
                        await renderPurchasesPage();
                    } catch (error) {
                        console.error('Error deleting data by date:', error);
                        alert(getTranslation('alert_error_deleting_data'));
                    } finally {
                        closeModal('confirm-modal');
                    }
                }
            });
        }

        async function handleDeleteDataByMonth() {
            const month = document.getElementById('delete-data-month').value;
            const year = document.getElementById('delete-data-year').value;
            const monthName = getTranslation('month_names')[month - 1];

            if (!month || !year) {
                alert(getTranslation('alert_select_month_year'));
                return;
            }

            const monthPadded = month.toString().padStart(2, '0');
            const startDate = `${year}-${monthPadded}-01`;
            const lastDayOfMonth = new Date(year, month, 0).getDate();
            const endDate = `${year}-${monthPadded}-${lastDayOfMonth}`;

            showConfirmation({
                title: getTranslation('label_delete_by_month'),
                message: getTranslation('confirm_delete_data_for_month_msg', { monthName, year }),
                async onConfirm() {                    
                    try {
                        await deleteTransactionsAndReconcileStock(startDate, endDate);
                        alert(getTranslation('alert_data_deleted_for_month', { monthName, year }));
                        await renderDashboard();
                        await renderPurchasesPage();
                    } catch (error) {
                        console.error('Error deleting data by month:', error);
                        alert(getTranslation('alert_error_deleting_data'));
                    } finally {
                        closeModal('confirm-modal');
                    }
                }
            });
        }

        function handleResetAllData() {
            const confirmWord = getTranslation('prompt_reset_confirm_word');
            showConfirmation({
                title: getTranslation('confirm_reset_all_data_title'),
                message: getTranslation('prompt_reset_all_data_msg'),
                requiresInput: true,
                inputPlaceholder: getTranslation('prompt_reset_confirm_word'),
                async onConfirm(inputValue) {
                    if (inputValue !== confirmWord) {
                        alert(getTranslation('alert_reset_cancelled'));
                        closeModal('confirm-modal');
                        return;
                    }
                    
                    try {
                        const storeNames = ['products', 'categories', 'stock', 'purchases', 'orders'];
                        const tx = dbInstance.transaction(storeNames, 'readwrite');
                        for (const storeName of storeNames) tx.objectStore(storeName).clear();
                        await new Promise((resolve, reject) => { tx.oncomplete = resolve; tx.onerror = event => reject(event.target.error); });

                        alert(getTranslation('alert_all_data_reset'));
                        
                        await initSampleData();
                        await populateFilterDropdowns();
                        state.currentSection = 'dashboard';
                        await render();

                    } catch (error) {
                        console.error('Failed to reset data:', error);
                        alert(getTranslation('alert_reset_fail'));
                    } finally {
                        closeModal('confirm-modal');
                    }
                }
            });
        }
        
        async function generateReportData(date, isMonthly = false) {
            let sales, purchases;
            let dateTitle;
            const allProducts = await db.getAll('products');

            if (isMonthly) {
                const [year, month] = date.split('-');
                const monthName = getTranslation('month_names')[parseInt(month) - 1];
                dateTitle = `${monthName}, ${year}`;
                
                const rangePrefix = `${year}-${month.toString().padStart(2, '0')}`;
                sales = (await db.getAll('orders')).filter(o => o.date.startsWith(rangePrefix) && o.status === 'completed');
                purchases = (await db.getAll('purchases')).filter(p => p.dateTime.startsWith(rangePrefix));
            } else {
                dateTitle = new Date(date + 'T00:00').toLocaleDateString();
                const range = IDBKeyRange.only(date);
                sales = (await db.getAll('orders', 'date', range)).filter(o => o.status === 'completed');
                
                const purchaseRange = IDBKeyRange.bound(`${date}T00:00`, `${date}T23:59:59`);
                purchases = await db.getAll('purchases', 'dateTime', purchaseRange);
            }

            const totalRevenue = sales.reduce((sum, order) => sum + order.total, 0);
            const totalCost = purchases.reduce((sum, p) => sum + p.totalCost, 0);
            const netProfit = totalRevenue - totalCost;

            const productSales = new Map();
            sales.forEach(order => {
                order.items.forEach(item => {
                    const currentQty = productSales.get(item.productId) || 0;
                    productSales.set(item.productId, currentQty + item.quantity);
                });
            });

            const topSellingProducts = Array.from(productSales.entries())
                .sort(([, qtyA], [, qtyB]) => qtyB - qtyA)
                .slice(0, 7)
                .map(([productId, quantity]) => {
                    const product = allProducts.find(p => p.id === productId);
                    return {
                        name: product ? product.name : 'Unknown Product',
                        quantity
                    };
                });

            return { dateTitle, totalRevenue, totalCost, netProfit, sales, purchases, topSellingProducts };
        }
        
        function renderReportModal(data) {
            state.reportData = data;
            const { dateTitle, totalRevenue, totalCost, netProfit, sales, purchases, topSellingProducts } = data;
            document.getElementById('report-date-title').textContent = dateTitle;
            const contentEl = document.getElementById('report-content');
            
            contentEl.innerHTML = `
                <div class="akmstats-grid">
                    <div class="akmstat-card"><span class="akmstat-title">${getTranslation('stat_total_revenue')}</span><span class="akmstat-value">${formatCurrency(totalRevenue)}</span></div>
                    <div class="akmstat-card"><span class="akmstat-title">${getTranslation('stat_total_cost')}</span><span class="akmstat-value">${formatCurrency(totalCost)}</span></div>
                    <div class="akmstat-card"><span class="akmstat-title">${getTranslation('stat_net_profit')}</span><span class="akmstat-value">${formatCurrency(netProfit)}</span></div>
                </div>

                <h4 style="margin-top: 20px;">${getTranslation('title_completed_sales', { count: sales.length })}</h4>
                <div class="akmtable-responsive" style="max-height: 200px;">
                    <table class="akmtable">
                        <thead><tr><th>ID</th><th>Date</th><th>Items</th><th>Total</th><th>Actions</th></tr></thead>
                        <tbody>${sales.length ? sales.map(s => `<tr><td>#${s.id.slice(-5)}</td><td>${new Date(s.dateTime).toLocaleString()}</td><td>${s.items.length}</td><td>${formatCurrency(s.total)}</td><td><button class="akmbtn akmbtn-sm akmbtn-outline-primary" data-action="view-sale-details" data-id="${s.id}"><i class="fas fa-eye"></i></button></td></tr>`).join('') : `<tr><td colspan="5" class="akm-text-center">No completed sales.</td></tr>`}</tbody>
                    </table>
                </div>

                <h4 style="margin-top: 20px;">${getTranslation('title_purchases_made', { count: purchases.length })}</h4>
                <div class="akmtable-responsive" style="max-height: 200px;">
                    <table class="akmtable">
                        <thead><tr><th>Product</th><th>Qty</th><th>Total Cost</th></tr></thead>
                        <tbody>${purchases.length ? purchases.map(p => `<tr><td>${p.productName}</td><td>${p.quantity}</td><td>${formatCurrency(p.totalCost)}</td></tr>`).join('') : `<tr><td colspan="3" class="akm-text-center">No purchases.</td></tr>`}</tbody>
                    </table>
                </div>

                <h4 style="margin-top: 20px;">${getTranslation('title_top_selling_products')}</h4>
                <div class="akmrow">
                    <div class="akmcol-md-6">
                        <div class="akmtable-responsive" style="max-height: 240px;">
                            <table class="akmtable">
                                <thead><tr><th>Product</th><th>${getTranslation('table_quantity_sold')}</th></tr></thead>
                                <tbody>${topSellingProducts.length ? topSellingProducts.map(p => `<tr><td>${p.name}</td><td>${p.quantity}</td></tr>`).join('') : `<tr><td colspan="2" class="akm-text-center">No sales data.</td></tr>`}</tbody>
                            </table>
                        </div>
                    </div>
                    <div class="akmcol-md-6" style="display: flex; align-items: center; justify-content: center; min-height: 240px;">
                        <canvas id="top-products-pie-chart"></canvas>
                    </div>
                </div>
            `;
            openModal('report-modal');
            renderTopProductsPieChart(topSellingProducts);
        }
        
        function renderTopProductsPieChart(data) {
            if (topProductsPieChart) {
                topProductsPieChart.destroy();
            }
            if (!data || data.length === 0) return;

            const ctx = document.getElementById('top-products-pie-chart').getContext('2d');
            const labels = data.map(p => p.name);
            const quantities = data.map(p => p.quantity);
            const style = getComputedStyle(document.body);
            const textColor = style.getPropertyValue('--text-emphasis').trim();

            topProductsPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: getTranslation('table_quantity_sold'),
                        data: quantities,
                        backgroundColor: ['#ff8839', '#ff9e5e', '#eb843f', '#E63946', '#FFA500', '#4e515e', '#26211c'],
                        borderColor: style.getPropertyValue('--glass-bg').trim(),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: textColor,
                                boxWidth: 15,
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        async function generateDailyReport() {
            const date = UIElements.reportDate.value;
            if (!date) { alert(getTranslation('alert_select_date')); return; }
            const data = await generateReportData(date, false);
            renderReportModal(data);
        }
        
        async function generateMonthlyReport() {
            const month = UIElements.reportMonth.value;
            const year = UIElements.reportYear.value;
            if (!month || !year) { alert(getTranslation('alert_select_month_year')); return; }
            const data = await generateReportData(`${year}-${month}`, true);
            renderReportModal(data);
        }

        async function exportToPDF(elementSelector, filename) {
            const { jsPDF } = window.jspdf;
            const content = document.querySelector(elementSelector);
            if (!content) return;

            try {
                const canvas = await html2canvas(content, { scale: 2, useCORS: true, backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-color') });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(filename);
            } catch (error) {
                console.error("PDF Export Error:", error);
                alert("Failed to export PDF.");
            }
        }
        
        function handleExportPurchasesPDF() {
            exportToPDF('#purchases-section .akmtable-responsive', `purchases-report-${Date.now()}.pdf`);
        }

        function handleExportReportCSV() {
            if (!state.reportData) return;
            const { dateTitle, totalRevenue, totalCost, netProfit, sales, purchases, topSellingProducts } = state.reportData;
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            csvContent += `Report for,${dateTitle}\n\n`;
            csvContent += `Summary\n`;
            csvContent += `Metric,Value\n`;
            csvContent += `Total Revenue,${totalRevenue}\n`;
            csvContent += `Total Cost,${totalCost}\n`;
            csvContent += `Net Profit,${netProfit}\n\n`;

            csvContent += `Completed Sales\n`;
            csvContent += `Sale ID,Date,Item Count,Total\n`;
            sales.forEach(s => csvContent += `#${s.id.slice(-5)},"${new Date(s.dateTime).toLocaleString()}",${s.items.length},${s.total}\n`);
            csvContent += `\n`;

            csvContent += `Purchases\n`;
            csvContent += `Product Name,Quantity,Total Cost\n`;
            purchases.forEach(p => csvContent += `"${p.productName}",${p.quantity},${p.totalCost}\n`);
            csvContent += `\n`;

            csvContent += `Top Selling Products\n`;
            csvContent += `Product Name,Quantity Sold\n`;
            topSellingProducts.forEach(p => csvContent += `"${p.name}",${p.quantity}\n`);

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `report-${dateTitle.replace(/ /g, '_')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function handleExportPurchasesCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const isBakery = state.appMode === 'bakery';
            csvContent += `Product Name,Supplier,Quantity,Unit Cost,Total Cost,Date${isBakery ? ',Expiry Date' : ''}\n`;
            state.filteredPurchases.forEach(p => {
                csvContent += `"${p.productName}","${p.supplier || ''}",${p.quantity},${p.unitCost},${p.totalCost},"${new Date(p.dateTime).toLocaleString()}"${isBakery ? ',' + (p.expiryDate || '') : ''}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `purchases-report-${Date.now()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function launchGenericScanner(callback) {
            onScanSuccessCallback = callback;
            openModal('barcode-scanner-modal');
            html5QrCodeScanner = new Html5Qrcode("barcode-scanner-container");
            const qrCodeSuccessCallback = async (decodedText, decodedResult) => {
                if (html5QrCodeScanner.getState() === 2){ // 2: SCANNING
                    await html5QrCodeScanner.stop();
                }
                closeModal('barcode-scanner-modal');
                if (typeof onScanSuccessCallback === 'function') {
                    onScanSuccessCallback(decodedText);
                }
                onScanSuccessCallback = null;
            };
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCodeScanner.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
              .catch(err => console.log(`Unable to start scanning, error: ${err}`));
        }

        async function handleScannedBarcodeForOrder(barcode) {
            const product = await db.getFromIndex('products', 'barcode', barcode);
            if (product) {
                addProductToOrder(product.id);
            } else {
                alert(getTranslation('alert_barcode_not_found', { barcode }));
            }
        }
        
        async function handleScannedBarcodeForPurchase(barcode) {
            const product = await db.getFromIndex('products', 'barcode', barcode);
            if (product) {
                UIElements.purchaseCategorySelect.value = product.categoryId;
                await handlePurchaseCategoryChange();
                UIElements.purchaseProductSelect.value = product.id;
            } else {
                alert(getTranslation('alert_barcode_not_found', { barcode }));
            }
        }
        
        async function connectToBluetoothPrinter() {
            if (!('bluetooth' in navigator)) {
                alert(getTranslation('alert_bt_unavailable'));
                return;
            }
            try {
                UIElements.printerStatus.textContent = getTranslation('status_connecting_printer');
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }], // Generic SPP
                });

                connectedPrinter = device;
                connectedPrinter.addEventListener('gattserverdisconnected', () => {
                     UIElements.printerStatus.textContent = getTranslation('status_printer_disconnected');
                     printerCharacteristic = null;
                });
                
                const server = await connectedPrinter.gatt.connect();
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                printerCharacteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
                
                UIElements.printerStatus.textContent = getTranslation('status_printer_connected', { printerName: connectedPrinter.name });
            } catch (error) {
                console.error('Bluetooth connection failed:', error);
                alert(getTranslation('alert_bt_connect_fail'));
                UIElements.printerStatus.textContent = getTranslation('status_no_printer');
            }
        }

        function generateReceiptText(order) {
             let text = '';
             text += `${getTranslation('receipt_sale_id')}: ${order.id.slice(-8)}\n`;
             text += `${getTranslation('receipt_date')}: ${new Date(order.dateTime).toLocaleString()}\n`;
             text += `${getTranslation('payment_method')}: ${getTranslation('payment_' + order.paymentMethod)}\n`;
             text += '--------------------------------\n';
             order.items.forEach(item => {
                 text += `${item.name}\n`;
                 text += `  ${item.quantity} x ${formatCurrency(item.price)} = ${formatCurrency(item.quantity * item.price)}\n`;
             });
             text += '--------------------------------\n';
             text += `${getTranslation('label_subtotal')}: ${formatCurrency(order.subtotal)}\n`;
             text += `${getTranslation('label_discount')}: -${formatCurrency(order.discount)}\n`;
             text += `${getTranslation('label_tax_rate_value', { rate: state.taxRate })}: ${formatCurrency(order.tax)}\n`;
             text += '================================\n';
             text += `${getTranslation('label_grand_total')}: ${formatCurrency(order.total)}\n\n`;
             text += `${getTranslation('receipt_thank_you')}\n\n\n`;
             return text;
        }
        
        async function printViaBluetooth(order) {
            if (!order || !printerCharacteristic) {
                alert(getTranslation('alert_bt_print_fail'));
                return;
            }
            try {
                const receiptText = generateReceiptText(order);
                const encoder = new TextEncoder();
                const data = encoder.encode(receiptText);
                await printerCharacteristic.writeValue(data);
            } catch (error) {
                console.error('Bluetooth printing failed:', error);
                alert(getTranslation('alert_bt_print_fail'));
            }
        }
        
        async function initAppCore() {
            try {
                await openDatabase();
                await initSampleData();
                
                const [theme, tax, language, appMode, barcodeMode] = await Promise.all([
                    db.get('settings', 'theme'),
                    db.get('settings', 'taxRate'),
                    db.get('settings', 'language'),
                    db.get('settings', 'appMode'),
                    db.get('settings', 'barcodeScannerMode'),
                ]);

                state.currentLanguage = language ? language.value : 'mm';
                await applyTheme();
                await setLanguage(state.currentLanguage);
                applyAppMode(appMode ? appMode.value : 'retail');
                applyBarcodeScannerMode(barcodeMode ? barcodeMode.value : 'off');

                state.taxRate = tax ? tax.value : 0;
                
                setupEventListeners();
                await render();
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to initialize application. Please refresh the page.');
            }
        }

        initAppCore();
    } 

    checkActivation();
});
</script>

 <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(error => {
            console.log('ServiceWorker registration failed: ', error);
          });
      });
    }
  </script></body></html>
